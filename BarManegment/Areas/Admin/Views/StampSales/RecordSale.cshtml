@model BarManegment.Areas.Admin.ViewModels.RecordStampSaleViewModel
@{
    ViewBag.Title = "تسجيل بيع طابع لمحامي";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        .form-control-plaintext.is-invalid {
            color: #dc3545;
        }

        .form-control-plaintext.is-valid {
            color: #198754;
        }

        .stamps-available-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<div class="card shadow mb-4">
    <div class="card-header py-3 text-white bg-primary">
        <h5 class="m-0 font-weight-bold"><i class="bi bi-cart-check-fill me-2"></i> تسجيل عملية بيع طابع لمحامي</h5>
    </div>
    <div class="card-body">
        @using (Html.BeginForm("RecordSale", "StampSales", new { area = "Admin" }, FormMethod.Post, new { id = "saleForm" }))
        {
            @Html.AntiForgeryToken()
            @Html.HiddenFor(m => m.LawyerId, new { id = "lawyerIdInput" })

            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-primary"><i class="bi bi-qr-code"></i> 1. بيانات الطابع والمتعهد</h5>
                    <hr />

                    @if (ViewBag.IsContractorUser == true)
                    {
                        @Html.HiddenFor(m => m.ContractorId)
                        <div class="mb-3">
                            <label class="form-label fw-bold">المتعهد البائع:</label>
                            <p class="form-control-plaintext fs-5 text-success">
                                <strong>@Session["FullName"]</strong>
                            </p>
                        </div>

                        <h6 class="mt-4">الطوابع المتاحة لديك (@(Model.AvailableStamps?.Count ?? 0))</h6>
                        <div class="stamps-available-list mb-3">
                            <table class="table table-sm table-hover" id="stampsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>الرقم التسلسلي</th>
                                        <th>القيمة</th>
                                        <th>اجراء</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.AvailableStamps == null || !Model.AvailableStamps.Any())
                                    {
                                        <tr><td colspan="3" class="text-center text-muted">لا توجد طوابع متاحة.</td></tr>
                                    }
                                    else
                                    {
                                        foreach (var stamp in Model.AvailableStamps)
                                        {
                                            <tr>
                                                <td>@stamp.SerialNumber</td>
                                                <td>@stamp.Value.ToString("N0") ₪</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-outline-primary select-stamp-btn" data-serial="@stamp.SerialNumber">اختر</button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="form-label fw-bold">اختر المتعهد البائع</label>
                            @Html.DropDownListFor(m => m.ContractorId, (SelectList)ViewBag.ContractorsList, "-- اختر المتعهد --", new { @class = "form-select", id = "contractorSelect" })
                            @Html.ValidationMessageFor(m => m.ContractorId, "", new { @class = "text-danger" })
                        </div>
                        <div id="contractorStampsContainer" style="display: none;">
                            <h6 class="mt-4 text-info">الطوابع المتوفرة بعهدة المتعهد</h6>
                            <div class="stamps-available-list mb-3">
                                <table class="table table-sm table-striped" id="contractorStampsTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>الرقم التسلسلي</th>
                                            <th>القيمة</th>
                                            <th>اختر</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    }

                    <div class="row bg-light p-3 rounded border">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-dark">من رقم تسلسلي</label>
                            @Html.TextBoxFor(m => m.StartSerial, new { @class = "form-control fw-bold", id = "StartSerial" })
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-dark">إلى رقم (اختياري)</label>
                            @Html.TextBoxFor(m => m.EndSerial, new { @class = "form-control", id = "EndSerial" })
                        </div>
                    </div>
                </div>

                <div class="col-md-6 border-start">
                    <h5 class="text-primary"><i class="bi bi-person-badge"></i> 2. بيانات المحامي المشتري</h5>
                    <hr />
                    <div class="mb-3">
                        <label class="form-label fw-bold">بحث برقم العضوية أو الاسم</label>
                        <div class="input-group">
                            @Html.TextBoxFor(m => m.LawyerSearchKey, new { @class = "form-control", id = "lawyerSearchInput" })
                            <button class="btn btn-info" type="button" id="checkLawyerBtn"><i class="bi bi-search"></i> فحص</button>
                        </div>
                    </div>

                    <div id="lawyerCheckResult" class="mb-3"></div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">اسم المحامي المعتمد</label>
                        @Html.TextBoxFor(m => m.LawyerName, new { @class = "form-control-plaintext fs-5 fw-bold text-primary", id = "lawyerNameInput", @readonly = "readonly" })
                        @Html.ValidationMessageFor(m => m.LawyerName, "", new { @class = "text-danger" })
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small text-muted">البنك</label>
                            @Html.TextBoxFor(m => m.LawyerBankName, new { @class = "form-control form-control-sm", id = "lawyerBankNameInput", @readonly = "readonly" })
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label small text-muted">الفرع</label>
                            @Html.TextBoxFor(m => m.LawyerBankBranch, new { @class = "form-control form-control-sm", id = "lawyerBankBranchInput", @readonly = "readonly" })
                        </div>
                    </div>
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle"></i> يتم جلب البيانات البنكية آلياً من ملف المحامي لأغراض صرف المستحقات لاحقاً.
                    </div>
                </div>
            </div>

            <div class="text-center mt-4 border-top pt-3">
                <button type="submit" class="btn btn-success btn-lg px-5 shadow" id="submitButton" disabled>
                    <i class="bi bi-save-fill"></i> تنفيذ وحفظ العملية
                </button>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var submitBtn = $('#submitButton');

            $('#checkLawyerBtn').on('click', function () {
                var key = $('#lawyerSearchInput').val();
                if (!key) return;

                $('#lawyerCheckResult').html('<span class="spinner-border spinner-border-sm"></span> جاري البحث...');

                $.post('@Url.Action("CheckLawyer")', { searchKey: key, __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() }, function (res) {
                    if (res.success) {
                        $('#lawyerNameInput').val(res.lawyerName);
                        $('#lawyerIdInput').val(res.lawyerId);
                        $('#lawyerBankNameInput').val(res.lawyerBankName || '-');
                        $('#lawyerBankBranchInput').val(res.lawyerBankBranch || '-');

                        if (res.isPracticing) {
                            submitBtn.prop('disabled', false);
                            $('#lawyerCheckResult').html('<div class="alert alert-success p-2 small"><i class="bi bi-check-circle"></i> المحامي فعال ومزاول.</div>');
                        } else {
                            submitBtn.prop('disabled', true);
                            $('#lawyerCheckResult').html('<div class="alert alert-danger p-2 small"><i class="bi bi-x-circle"></i> المحامي غير مزاول حالياً.</div>');
                        }
                    } else {
                        $('#lawyerCheckResult').html('<div class="alert alert-warning p-2 small">عذراً، لم يتم العثور على المحامي.</div>');
                        submitBtn.prop('disabled', true);
                    }
                });
            });

 $('#contractorSelect').on('change', function() {
    var id = $(this).val();
    if(!id) { $('#contractorStampsContainer').hide(); return; }

    $('#contractorStampsContainer').show();
    $('#contractorStampsTable tbody').html('<tr><td colspan="3" class="text-center">جاري التحميل...</td></tr>');

    $.get('@Url.Action("GetContractorStamps")', { contractorId: id }, function(data) {
        var html = '';
        if(data.length == 0) {
            html = '<tr><td colspan="3" class="text-center text-danger">لا يوجد طوابع في عهدة هذا المتعهد حالياً (الحالة: مع المتعهد).</td></tr>';
        } else {
            $.each(data, function(i, s) {
                html += '<tr>' +
                        '<td>' + s.SerialNumber + '</td>' +
                        '<td>' + s.Value + ' ₪</td>' +
                        '<td><button type="button" class="btn btn-sm btn-outline-primary select-stamp-btn" data-serial="' + s.SerialNumber + '">اختر</button></td>' +
                        '</tr>';
            });
        }
        $('#contractorStampsTable tbody').html(html);
    }).fail(function() {
        $('#contractorStampsTable tbody').html('<tr><td colspan="3" class="text-center text-danger">حدث خطأ أثناء تحميل البيانات.</td></tr>');
    });
});

            $('body').on('click', '.select-stamp-btn', function() {
                $('#StartSerial').val($(this).data('serial'));
                $('#EndSerial').val('');
            });
        });
    </script>
}