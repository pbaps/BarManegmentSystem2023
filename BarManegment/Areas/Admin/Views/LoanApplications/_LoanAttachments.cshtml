@model BarManegment.Models.LoanApplication

<table class="table table-bordered align-middle mb-0">
    <thead class="table-light">
        <tr>
            <th>النموذج</th>
            <th>الحالة</th>
            <th>الطباعة (تعبئة بيانات)</th>
            <th>الرفع (بعد التوقيع)</th>
        </tr>
    </thead>
    <tbody>

        @* --- 1. طلب القرض --- *@
        <tr>
            <td><strong>1. طلب الحصول على قرض</strong></td>
            <td>
                @if (!string.IsNullOrEmpty(Model.ApplicationFormPath))
                {
                    <a href="@Url.Content(Model.ApplicationFormPath)" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-check-circle-fill me-1"></i> تم الرفع</a>
                }
                else
                {
                    <span class="text-danger"><i class="bi bi-x-circle-fill me-1"></i> لم يتم الرفع</span>
                }
            </td>
            <td>
                @Html.ActionLink("طباعة النموذج", "PrintApplicationForm", new { id = Model.Id }, new { @class = "btn btn-sm btn-info", target = "_blank" })
            </td>
            <td>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal" onclick="setUploadType('ApplicationForm')">
                    <i class="bi bi-upload"></i> رفع
                </button>
            </td>
        </tr>

        @* --- 2. سند المديونية --- *@
        <tr>
            <td><strong>2. سند إقرار ومديونية</strong></td>
            <td>
                @if (!string.IsNullOrEmpty(Model.DebtBondPath)) // تأكد من استخدام الاسم الصحيح DebtBondPath
                {
                    <a href="@Url.Content(Model.DebtBondPath)" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-check-circle-fill me-1"></i> تم الرفع</a>
                }
                else
                {
                    <span class="text-danger"><i class="bi bi-x-circle-fill me-1"></i> لم يتم الرفع</span>
                }
            </td>
            <td>
                @Html.ActionLink("طباعة النموذج", "PrintDebtBond", new { id = Model.Id }, new { @class = "btn btn-sm btn-info", target = "_blank" })
            </td>
            <td>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal" onclick="setUploadType('DebtBond')">
                    <i class="bi bi-upload"></i> رفع
                </button>
            </td>
        </tr>

        @* --- 3. الكمبيالة الكبرى --- *@
        <tr>
            <td><strong>3. كمبيالة بالمبلغ الكلي</strong></td>
            <td>
                @if (!string.IsNullOrEmpty(Model.MainPromissoryNotePath)) // تأكد من الاسم الصحيح
                {
                    <a href="@Url.Content(Model.MainPromissoryNotePath)" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-check-circle-fill me-1"></i> تم الرفع</a>
                }
                else
                {
                    <span class="text-danger"><i class="bi bi-x-circle-fill me-1"></i> لم يتم الرفع</span>
                }
            </td>
            <td>
                @Html.ActionLink("طباعة النموذج", "PrintMainPromissoryNote", new { id = Model.Id }, new { @class = "btn btn-sm btn-info", target = "_blank" })
            </td>
            <td>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal" onclick="setUploadType('MainPromissoryNote')">
                    <i class="bi bi-upload"></i> رفع
                </button>
            </td>
        </tr>

        @* --- 4. الكفلاء --- *@
        @foreach (var guarantor in Model.Guarantors)
        {
            <tr>
                <td><strong>4. كفالة (@(guarantor.GuarantorType == "Lawyer" ? guarantor.LawyerGuarantor.ArabicName : guarantor.ExternalName))</strong></td>
                <td>
                    @if (!string.IsNullOrEmpty(guarantor.GuarantorFormScannedPath))
                    {
                        <a href="@Url.Content(guarantor.GuarantorFormScannedPath)" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-check-circle-fill me-1"></i> تم الرفع</a>
                    }
                    else
                    {
                        <span class="text-danger"><i class="bi bi-x-circle-fill me-1"></i> لم يتم الرفع</span>
                    }
                </td>
                <td>
                    @Html.ActionLink("طباعة النموذج", "PrintGuarantorForm", new { id = guarantor.Id }, new { @class = "btn btn-sm btn-info", target = "_blank" })
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal" onclick="setUploadType('Guarantor_@guarantor.Id')">
                        <i class="bi bi-upload"></i> رفع
                    </button>
                </td>
            </tr>
        }

        @* --- 5. قرار المجلس (اختياري) --- *@
        <tr>
            <td><strong>5. قرار مجلس (اختياري)</strong></td>
            <td>
                @if (!string.IsNullOrEmpty(Model.CouncilApprovalPath)) // تأكد من الاسم الصحيح
                {
                    <a href="@Url.Content(Model.CouncilApprovalPath)" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-check-circle-fill me-1"></i> تم الرفع</a>
                }
                else
                {
                    <span class="text-muted"><i class="bi bi-hourglass-split me-1"></i> اختياري</span>
                }
            </td>
            <td>
                @* قرار المجلس غالباً لا يطبع كنموذج فارغ بل هو وثيقة موجودة مسبقاً *@
                <span class="text-muted small">وثيقة داخلية</span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal" onclick="setUploadType('CouncilApproval')">
                    <i class="bi bi-upload"></i> رفع
                </button>
            </td>
        </tr>

    </tbody>
</table>

<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("UploadLoanDocument", "LoanApplications", FormMethod.Post, new { enctype = "multipart/form-data" }))
            {
                @Html.AntiForgeryToken()
                @Html.Hidden("id", Model.Id)
                <input type="hidden" name="docType" id="docTypeInput" />

                <div class="modal-header bg-light">
                    <h5 class="modal-title">رفع مستند</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">اختر الملف (PDF أو صورة)</label>
                        <input type="file" name="file" class="form-control" required accept=".pdf,.jpg,.jpeg,.png" />
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success px-4">رفع وحفظ</button>
                </div>
            }
        </div>
    </div>
</div>

<script>
    function setUploadType(type) {
        document.getElementById('docTypeInput').value = type;
    }
</script>