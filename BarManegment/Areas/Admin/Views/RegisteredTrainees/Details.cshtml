@model BarManegment.Areas.Admin.ViewModels.TraineeReviewViewModel
@using BarManegment.Models
@{
    ViewBag.Title = "الملف الشامل للمتدرب: " + Model.ArabicName;
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";

    DateTime? actualEndDate = ViewBag.ActualEndDate as DateTime?;
    int suspensionDays = ViewBag.TotalSuspensionDays != null ? (int)ViewBag.TotalSuspensionDays : 0;

    // استلام القوائم من الموديل
    var suspensionHistory = Model.CouncilSuspensions ?? new List<TraineeSuspension>();
    var supervisorHistory = Model.SupervisorChangeRequests ?? new List<SupervisorChangeRequest>();
    var paymentHistory = Model.PaymentHistory ?? new List<Receipt>();
    var examHistory = Model.ExamHistory ?? new List<ExamEnrollment>();
    var oralExamHistory = Model.OralExamHistory ?? new List<OralExamEnrollment>();
    var trainingLogs = Model.TrainingLogs ?? new List<TrainingLog>();
    var legalResearches = Model.LegalResearches ?? new List<LegalResearch>();

    var attendedSessions = ViewBag.AttendedSessions as List<TraineeAttendance>;

    // حساب الساعات
    double completedHours = ViewBag.CompletedTrainingHours != null ? (double)ViewBag.CompletedTrainingHours : 0;
    double requiredHours = ViewBag.RequiredTrainingHours != null ? (double)ViewBag.RequiredTrainingHours : 0;

    // --- حساب حالة الإنجاز ---
    bool periodCompleted = actualEndDate.HasValue && DateTime.Now >= actualEndDate.Value;

    bool writtenExamPassed = examHistory.Any(e =>
        e.Exam != null && e.Exam.ExamType != null &&
        (e.Exam.ExamType.Name.Contains("تحريري") ||
         e.Exam.ExamType.Name.Contains("إلكتروني") ||
         e.Exam.ExamType.Name.Contains("إنهاء") ||
         e.Exam.ExamType.Name.Contains("انتهاء"))
        && e.Result == "ناجح");

    bool oralExamPassed = oralExamHistory.Any(o => o.Result == "ناجح");

    bool researchAccepted = legalResearches.Any(r =>
        r.Status == "مقبول" ||
        r.Status == "مكتمل" ||
        (r.Decisions != null && r.Decisions.Any(d => d.Result == "ناجح"))
    );

    bool hoursCompleted = requiredHours == 0 || completedHours >= requiredHours;

    var activeSuspension = suspensionHistory.FirstOrDefault(s => s.Status == "معتمد" && (s.SuspensionEndDate == null || s.SuspensionEndDate >= DateTime.Now));
}

<div class="container-fluid pt-4 px-4">

    <!-- 1. بطاقة التعريف العلوية -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="position-relative">
                        <img src="@(!string.IsNullOrEmpty(Model.PersonalPhotoPath) ? Url.Content(Model.PersonalPhotoPath) : "/Content/Images/default-avatar.png")"
                             class="rounded-circle border border-3 border-light shadow-sm"
                             style="width: 120px; height: 120px; object-fit: cover;">

                        @{
                            string statusColor = "bg-secondary";
                            if (Model.Status == "متدرب مقيد") { statusColor = "bg-success"; }
                            else if (Model.Status == "متدرب موقوف") { statusColor = "bg-danger"; }
                            else if (Model.Status == "محامي مزاول") { statusColor = "bg-primary"; }
                        }
                        <span class="position-absolute bottom-0 start-100 translate-middle p-2 border border-light rounded-circle @statusColor">
                            <span class="visually-hidden">Status</span>
                        </span>
                    </div>
                </div>
                <div class="col">
                    <div class="d-flex align-items-center mb-1">
                        <h2 class="fw-bold text-primary mb-0">@Model.ArabicName</h2>
                        <span class="badge rounded-pill ms-3 @statusColor">@Model.Status</span>
                    </div>

                    <p class="text-muted mb-2 fs-5">@Model.EnglishName</p>

                    <div class="d-flex flex-wrap gap-3 text-secondary">
                        <span class="badge bg-light text-dark border"><i class="bi bi-upc-scan me-1"></i> الرقم النقابي: @(Model.TraineeSerialNo ?? "---")</span>
                        <span><i class="bi bi-card-heading me-1"></i> هوية: @Model.NationalIdNumber</span>
                        <span><i class="bi bi-geo-alt me-1"></i> @(Model.ContactInfo?.Governorate ?? "غير محدد")</span>
                    </div>
                </div>
                <div class="col-auto text-end">
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear-fill me-1"></i> إجراءات إدارية
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">إدارة الملف</h6></li>
                            <li><a class="dropdown-item" href="@Url.Action("Edit", "RegisteredTrainees", new { area = "Admin", id = Model.Id })"><i class="bi bi-pencil-square me-2"></i> تعديل البيانات</a></li>
                            <li><a class="dropdown-item" href="@Url.Action("PrintIdCard", new { id = Model.Id })" target="_blank"><i class="bi bi-credit-card-2-front me-2"></i> طباعة البطاقة</a></li>
                            <li><hr class="dropdown-divider"></li>

                            <li><a class="dropdown-item" href="@Url.Action("Create", "SupervisorChangeRequests", new { area = "Admin", traineeId = Model.Id, requestType = "نقل" })"><i class="bi bi-arrow-left-right me-2"></i> طلب نقل إشراف</a></li>

                            @if (activeSuspension == null)
                            {
                                <li><button class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#councilSuspensionModal"><i class="bi bi-slash-circle me-2"></i> تسجيل إيقاف إداري</button></li>
                            }
                            else
                            {
                                <li><button class="dropdown-item text-success" data-bs-toggle="modal" data-bs-target="#endSuspensionModal"><i class="bi bi-play-circle me-2"></i> إنهاء الإيقاف (استئناف)</button></li>
                            }

                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">المتطلبات الأكاديمية</h6></li>
                            @if (!researchAccepted)
                            {
                                <li><a class="dropdown-item" href="@Url.Action("SubmitResearch", "LegalResearch", new { area = "Admin", traineeId = Model.Id })"><i class="bi bi-journal-plus me-2"></i> تقديم بحث قانوني</a></li>
                            }
                            else
                            {
                                <li><span class="dropdown-item text-muted disabled"><i class="bi bi-check2-circle me-2"></i> تم اجتياز البحث</span></li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. بطاقة متطلبات اليمين -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-check me-2 text-primary"></i> حالة متطلبات أداء اليمين القانونية</span>
            @if (Model.CanApplyForOath)
            {<span class="badge bg-success">مؤهل للتقديم</span> }
            else
            { <span class="badge bg-warning text-dark">غير مكتمل</span>}
        </div>
        <div class="card-body">
            <div class="row">
                <!-- المنجزات -->
                <div class="col-md-6 border-end">
                    <h6 class="text-success fw-bold mb-3 border-bottom pb-2">ما تم إنجازه <i class="bi bi-check-circle-fill"></i></h6>
                    <ul class="list-group list-group-flush small">
                        @if (periodCompleted)
                        {
                            <li class="list-group-item border-0 ps-0 text-success bg-transparent"><i class="bi bi-check-lg me-2"></i> إتمام المدة القانونية (عامين)</li>
}
                        @if (writtenExamPassed)
                        {
                            <li class="list-group-item border-0 ps-0 text-success bg-transparent"><i class="bi bi-check-lg me-2"></i> اجتياز الامتحان التحريري</li>
}
                        @if (oralExamPassed)
                        {
                            <li class="list-group-item border-0 ps-0 text-success bg-transparent"><i class="bi bi-check-lg me-2"></i> اجتياز الامتحان الشفوي</li>
}
                        @if (researchAccepted)
                        {
                            <li class="list-group-item border-0 ps-0 text-success bg-transparent"><i class="bi bi-check-lg me-2"></i> قبول البحث القانوني</li>
}
                        @if (hoursCompleted && requiredHours > 0)
                        {
                            <li class="list-group-item border-0 ps-0 text-success bg-transparent"><i class="bi bi-check-lg me-2"></i> إتمام ساعات التدريب (@completedHours ساعة)</li>
}
                        <li class="list-group-item border-0 ps-0 text-muted"><i class="bi bi-info-circle me-2"></i> الحالة: @Model.Status</li>
                    </ul>
                </div>
                <!-- المتبقي -->
                <div class="col-md-6 ps-4">
                    <h6 class="text-danger fw-bold mb-3 border-bottom pb-2">المتطلبات المتبقية <i class="bi bi-hourglass-split"></i></h6>
                    @if (Model.OathEligibilityIssues != null && Model.OathEligibilityIssues.Any())
                    {
                        <ul class="list-group list-group-flush small">
                            @foreach (var issue in Model.OathEligibilityIssues)
                            {
                                <li class="list-group-item border-0 ps-0 text-danger"><i class="bi bi-x-circle me-2"></i> @issue</li>
}
                        </ul>
                    }
                    else
                    {
                        <div class="text-center text-success py-3 bg-light rounded mb-3">
                            <i class="bi bi-stars fs-1 d-block mb-2"></i>
                            <strong>جميع المتطلبات مكتملة!</strong>
                            <br>يمكن للمتدرب الآن استكمال إجراءات التخرج.

                        </div>

                        <!-- 💡 أزرار إنهاء التدريب وطلب اليمين (تظهر فقط عند الاكتمال) -->
                        <div class="d-grid gap-2">
                            <a href="@Url.Action("PrintApplicationForm", "RegisteredTrainees", new { area = "Admin", id = Model.Id })" target="_blank" class="btn btn-outline-dark">
                                <i class="bi bi-printer me-2"></i> طباعة نموذج انتهاء التدريب
                            </a>
                            <a href="@Url.Action("Create", "OathRequests", new { area = "Admin", traineeId = Model.Id })" class="btn btn-success fw-bold shadow-sm">
                                <i class="bi bi-patch-check-fill me-2"></i> تقديم طلب أداء اليمين
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- 3. شريط ملخص التدريب -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 bg-primary bg-opacity-10 border-start border-4 border-primary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">تاريخ بدء التدريب</h6>
                    <h4 class="mb-0 fw-bold text-primary">@(Model.TrainingStartDate?.ToString("yyyy-MM-dd") ?? "---")</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 bg-warning bg-opacity-10 border-start border-4 border-warning">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">أيام التوقف (Suspension)</h6>
                    <h4 class="mb-0 fw-bold text-warning">@suspensionDays يوم</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 bg-success bg-opacity-10 border-start border-4 border-success">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">نهاية التدريب (المتوقعة)</h6>
                    <h4 class="mb-0 fw-bold text-success">@(actualEndDate?.ToString("yyyy-MM-dd") ?? "---")</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-secondary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">ساعات التدريب</h6>
                    <h4 class="mb-0 fw-bold @(hoursCompleted ? "text-success" : "text-danger")">@completedHours / @requiredHours</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-9">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom pt-3 px-4">
                    <ul class="nav nav-tabs card-header-tabs" id="traineeDetailsTab" role="tablist">
                        <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#info">البيانات</button></li>
                        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#exams">الامتحانات والأبحاث</button></li>
                        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#courses">الدورات</button></li>
                        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#finance">المالية</button></li>
                        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#history">السجلات</button></li>
                        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#docs">الوثائق</button></li>
                    </ul>
                </div>
                <div class="card-body p-4">
                    <div class="tab-content">

                        <!-- 1. البيانات الشخصية (مع زر التعديل) -->
                        <div class="tab-pane fade show active" id="info">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-primary fw-bold m-0"><i class="bi bi-person-lines-fill me-2"></i> البيانات الشخصية والاتصال</h6>
                                <!-- 💡 زر تعديل البيانات -->
                                <a href="@Url.Action("Edit", "RegisteredTrainees", new { area = "Admin", id = Model.Id })" class="btn btn-sm btn-warning shadow-sm text-dark fw-bold">
                                    <i class="bi bi-pencil-square me-1"></i> تعديل البيانات
                                </a>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-4"><label class="small text-muted">رقم الجوال</label><div class="fw-bold" dir="ltr">@Model.ContactInfo.MobileNumber</div></div>
                                <div class="col-md-4"><label class="small text-muted">البريد الإلكتروني</label><div class="fw-bold">@Model.ContactInfo.Email</div></div>
                                <div class="col-md-4"><label class="small text-muted">المحافظة</label><div class="fw-bold">@Model.ContactInfo.Governorate</div></div>
                                <div class="col-md-12"><label class="small text-muted">العنوان التفصيلي</label><div>@Model.ContactInfo.City - @Model.ContactInfo.Street</div></div>
                            </div>
                            <hr class="text-muted opacity-25">
                            <h6 class="text-primary fw-bold mb-3"><i class="bi bi-briefcase me-2"></i> المشرف الحالي</h6>
                            @if (Model.Supervisor != null)
                            {
                                <div class="d-flex align-items-center bg-light p-3 rounded border border-start border-5 border-primary">
                                    <div class="avatar-initial rounded bg-white border me-3 p-2"><i class="bi bi-person-workspace fs-4 text-primary"></i></div>
                                    <div><h6 class="mb-0 fw-bold">@Model.Supervisor.ArabicName</h6><small class="text-muted">المحامي المشرف</small></div>
                                    <div class="ms-auto"><span class="badge bg-success">ساري المفعول</span></div>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-exclamation-triangle me-2"></i> لا يوجد مشرف حالي.</span>
                                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#supervisorSearchModal"><i class="bi bi-plus-lg me-1"></i> تعيين مشرف</button>
                                </div>
                            }
                        </div>

                        <!-- 2. الامتحانات والأبحاث -->
                        <div class="tab-pane fade" id="exams">
                            <div class="row">
                                <!-- قسم الامتحانات -->
                                <div class="col-md-5">
                                    <h6 class="fw-bold mb-3 text-primary">سجل الامتحانات التحريرية</h6>
                                    @if (examHistory != null && examHistory.Any())
                                    {
                                        <table class="table table-bordered table-sm table-hover mb-4">
                                            <thead class="table-light"><tr><th>الامتحان</th><th>التاريخ</th><th>النتيجة</th></tr></thead>
                                            <tbody>
                                                @foreach (var exam in examHistory)
                                                {
                                                    <tr>
                                                        <td>@exam.Exam.ExamType.Name</td>
                                                        <td>@exam.Exam.StartTime.ToString("yyyy-MM-dd")</td>
                                                        <td>
                                                            @if (string.IsNullOrEmpty(exam.Result))
                                                            {<span class="badge bg-secondary">قيد الانتظار</span> }
                                                            else if (exam.Result == "ناجح")
                                                            { <span class="badge bg-success">ناجح</span> }
                                                            else if (exam.Result == "راسب")
                                                            { <span class="badge bg-danger">راسب</span> }
                                                            else
                                                            { <span class="badge bg-warning text-dark">@exam.Result</span>}
                                                        </td>
                                                    </tr>

                                                }
                                            </tbody>
                                        </table>
                                    }
                                    else
                                    { <p class="text-muted small p-3 bg-light rounded mb-4">لم يتقدم لأي امتحان تحريري بعد.</p>}

                                    <hr class="my-4">

                                    <h6 class="fw-bold mb-3 text-primary">سجل الامتحانات الشفوية</h6>
                                    @if (oralExamHistory != null && oralExamHistory.Any())
                                    {
                                        <table class="table table-bordered table-sm table-hover mb-4">
                                            <thead class="table-light"><tr><th>اللجنة</th><th>التاريخ</th><th>النتيجة</th></tr></thead>
                                            <tbody>
                                                @foreach (var exam in oralExamHistory)
                                                {
                                                    <tr>
                                                        <td>@(exam.OralExamCommittee?.CommitteeName ?? "غير محدد")</td>
                                                        <td>@exam.ExamDate.ToString("yyyy-MM-dd")</td>
                                                        <td>
                                                            @if (string.IsNullOrEmpty(exam.Result) || exam.Result == "قيد الانتظار")
                                                            {<span class="badge bg-secondary">قيد الانتظار</span> }
                                                            else if (exam.Result == "ناجح")
                                                            { <span class="badge bg-success">ناجح</span> }
                                                            else if (exam.Result == "راسب")
                                                            { <span class="badge bg-danger">راسب</span> }
                                                            else
                                                            { <span class="badge bg-warning text-dark">@exam.Result</span>}
                                                        </td>
                                                    </tr>

                                                }
                                            </tbody>
                                        </table>
                                    }
                                    else
                                    { <p class="text-muted small p-3 bg-light rounded mb-4">لم يتقدم لأي امتحان شفوي بعد.</p>}
                                </div>

                                <!-- قسم الأبحاث -->
                                <div class="col-md-7">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="fw-bold m-0">الأبحاث القانونية (سير العملية)</h6>
                                        @if (!researchAccepted)
                                        {
                                            <a href="@Url.Action("SubmitResearch", "LegalResearch", new { area = "Admin", traineeId = Model.Id })" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-plus-circle me-1"></i> تقديم بحث
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">تم اجتياز البحث <i class="bi bi-check-lg"></i></span>
                                        }
                                    </div>

                                    @if (legalResearches != null && legalResearches.Any())
                                    {
                                        <div class="accordion" id="researchAccordion">
                                            @foreach (var res in legalResearches)
                                            {
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header" id="heading-@res.Id">
                                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@res.Id" aria-expanded="false">
                                                            <div class="d-flex justify-content-between w-100 me-3">
                                                                <span class="fw-bold">@res.Title</span>
                                                                <span class="badge bg-info text-dark ms-2">@res.Status</span>
                                                            </div>
                                                        </button>
                                                    </h2>
                                                    <div id="collapse-@res.Id" class="accordion-collapse collapse" data-bs-parent="#researchAccordion">
                                                        <div class="accordion-body bg-light">
                                                            <p class="small text-muted mb-2">
                                                                تاريخ التقديم: @res.SubmissionDate.ToString("yyyy-MM-dd") |
                                                                <a href="@Url.Action("Details", "LegalResearch", new { area = "Admin", id = res.Id })" target="_blank" class="fw-bold">إدارة البحث</a>
                                                            </p>

                                                            <h6 class="small fw-bold mt-3 text-secondary">سجل قرارات اللجنة:</h6>
                                                            @if (res.Decisions != null && res.Decisions.Any())
                                                            {
                                                                <ul class="list-group list-group-flush small">
                                                                    @foreach (var dec in res.Decisions.OrderBy(d => d.DecisionDate))
                                                                    {
                                                                        <li class="list-group-item bg-transparent">
                                                                            <span class="badge bg-secondary ms-2">@dec.DecisionDate.ToString("yyyy-MM-dd")</span>
                                                                            <span class="fw-bold @(dec.Result == "ناجح" ? "text-success" : "text-danger")">@dec.Result</span>
                                                                            @if (!string.IsNullOrEmpty(dec.Notes))
                                                                            {<span class="text-muted d-block mt-1">"@dec.Notes"</span>}
                                                                        </li>
                                                                    }
                                                                </ul>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted small fst-italic d-block">لم يصدر أي قرار من اللجنة بعد.</span>
                                                            }

                                                            @if (!string.IsNullOrEmpty(res.FinalDocumentPath))
                                                            {
                                                                <div class="mt-3 border-top pt-2">
                                                                    <a href="@Url.Action("GetAttachmentFile", "RegisteredTrainees", new { id = res.Id })" target="_blank" class="btn btn-sm btn-success">
                                                                        <i class="bi bi-file-earmark-pdf me-1"></i> عرض الملف النهائي المعتمد
                                                                    </a>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    { <p class="text-muted small p-3 bg-light rounded mb-4">لا يوجد أبحاث مسجلة.</p>}
                                </div>
                            </div>
                        </div>

                        <!-- 3. الدورات -->
                        <div class="tab-pane fade" id="courses">
                            <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-journal-bookmark me-2"></i> الدورات والمحاضرات التدريبية</h6>
                            @if (attendedSessions != null && attendedSessions.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover align-middle">
                                        <thead class="table-light"><tr><th>الجلسة</th><th>الدورة</th><th>التاريخ</th><th>الساعات</th><th>المحاضر</th></tr></thead>
                                        <tbody>
                                            @foreach (var session in attendedSessions)
                                            {
                                                <tr>
                                                    <td class="fw-bold">@session.Session.SessionTitle</td>
                                                    <td>@session.Session.TrainingCourse.CourseName</td>
                                                    <td>@session.Session.SessionDate.ToString("yyyy-MM-dd")</td>
                                                    <td>@session.Session.CreditHours</td>
                                                    <td>@session.Session.InstructorName</td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot class="table-light"><tr><td colspan="3" class="text-end fw-bold">المجموع:</td><td class="fw-bold text-primary">@completedHours</td><td></td></tr></tfoot>
                                    </table>
                                </div>
                            }
                            else
                            { <div class="text-center py-5 bg-light rounded border border-dashed"><i class="bi bi-calendar-x fs-1 text-muted mb-2"></i><p class="text-muted mb-0">لم يتم تسجيل حضور.</p></div>}
                        </div>

                        <!-- 4. المالية -->
                        <div class="tab-pane fade" id="finance">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold m-0 text-success"><i class="bi bi-cash-coin me-2"></i> الملف المالي (الرسوم والإيصالات)</h6>
                                <a href="@Url.Action("Create", "PaymentVouchers", new { area = "Admin", id = Model.Id })" class="btn btn-sm btn-success">
                                    <i class="bi bi-plus-lg me-1"></i> إنشاء قسيمة دفع
                                </a>
                            </div>

                            <!-- سجل الإيصالات -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-light fw-bold">سجل الإيصالات والدفعات</div>
                                <div class="card-body p-0">
                                    @if (paymentHistory != null && paymentHistory.Any())
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>رقم الإيصال</th>
                                                        <th>تاريخ الدفع</th>
                                                        <th>المبلغ الإجمالي</th>
                                                        <th>تفاصيل الرسوم</th>
                                                        <th class="text-center">طباعة</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var receipt in paymentHistory)
                                                    {
                                                        <tr>
                                                            <td class="font-monospace fw-bold">@receipt.ReceiptNumber</td>
                                                            <td>@receipt.BankPaymentDate.ToString("yyyy-MM-dd")</td>
                                                            <td class="fw-bold text-success">@receipt.PaymentVoucher.TotalAmount.ToString("N0")</td>
                                                            <td>
                                                                <ul class="mb-0 ps-3 small text-muted">
                                                                    @if (receipt.PaymentVoucher != null && receipt.PaymentVoucher.VoucherDetails != null)
                                                                    {
                                                                        foreach (var d in receipt.PaymentVoucher.VoucherDetails)
                                                                        {
                                                                            <li>@d.FeeType.Name <span class="text-dark">(@d.Amount.ToString("N0"))</span></li>

                                                                        }
                                                                    }
                                                                </ul>
                                                            </td>
                                                            <td class="text-center">
                                                                <a href="@Url.Action("Details", "Receipts", new { area = "Admin", id = receipt.Id })" target="_blank" class="btn btn-sm btn-outline-secondary" title="طباعة الإيصال">
                                                                    <i class="bi bi-printer"></i>
                                                                </a>
                                                            </td>
                                                        </tr>

                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="text-center py-4 text-muted">لا يوجد سجلات دفع سابقة.</div>
                                    }
                                </div>
                            </div>

                            <!-- سجل التجديدات -->
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-light fw-bold">سجل التجديدات السنوية</div>
                                <div class="card-body p-0">
                                    @if (Model.Renewals != null && Model.Renewals.Any())
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>سنة التجديد</th>
                                                        <th>تاريخ التجديد</th>
                                                        <th>رقم إيصال الدفع</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var ren in Model.Renewals)
                                                    {
                                                        <tr>
                                                            <td class="fw-bold">@ren.RenewalYear</td>
                                                            <td>@ren.RenewalDate.ToString("yyyy-MM-dd")</td>
                                                            <td class="font-monospace">@ren.ReceiptId</td>
                                                        </tr>

                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="text-center py-4 text-muted">لم يتم تسجيل أي تجديد سنوي بعد.</div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- 5. السجلات التاريخية -->
                        <div class="tab-pane fade" id="history">
                            <h6 class="fw-bold mb-3 text-primary">سجل التنقلات (تغيير المشرف)</h6>
                            @if (supervisorHistory != null && supervisorHistory.Any())
                            {
                                <div class="table-responsive mb-4">
                                    <table class="table table-sm table-bordered table-hover">
                                        <thead class="table-light"><tr><th>تاريخ الطلب</th><th>نوع الطلب</th><th>المشرف الجديد</th><th>الحالة</th><th>تاريخ القرار</th></tr></thead>
                                        <tbody>
                                            @foreach (var item in supervisorHistory)
                                            {
                                                <tr><td>@item.RequestDate.ToString("yyyy-MM-dd")</td><td>@item.RequestType</td><td>@(item.NewSupervisor?.ArabicName ?? "-")</td><td><span class="badge bg-secondary">@item.Status</span></td><td>@item.DecisionDate?.ToString("yyyy-MM-dd")</td></tr>
}
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            { <p class="text-muted small mb-4 p-3 bg-light rounded">لا توجد سجلات تنقلات.</p>}

                            <hr />

                            <h6 class="fw-bold mb-3 text-danger">سجل الإيقافات والانقطاع</h6>
                            @if (suspensionHistory != null && suspensionHistory.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered table-hover">
                                        <thead class="table-light"><tr><th>تاريخ البدء</th><th>تاريخ الانتهاء</th><th>السبب</th><th>الحالة</th></tr></thead>
                                        <tbody>
                                            @foreach (var item in suspensionHistory)
                                            {
                                                <tr>
                                                    <td>@item.SuspensionStartDate.ToString("yyyy-MM-dd")</td>
                                                    <td>@(item.SuspensionEndDate?.ToString("yyyy-MM-dd") ?? "مفتوح")</td>
                                                    <td>@item.Reason</td>
                                                    <td>
                                                        @if (item.Status == "معتمد" && item.SuspensionEndDate == null)
                                                        {<span class="badge bg-danger">ساري</span> }
                                                        else
                                                        { <span class="badge bg-secondary">منتهي</span>}
                                                    </td>
                                                </tr>

                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            { <p class="text-muted small p-3 bg-light rounded">لا توجد سجلات إيقاف.</p>}
                        </div>

                        <!-- 6. الوثائق -->
                        <div class="tab-pane fade" id="docs">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold m-0">المؤهلات العلمية</h6>
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addQualificationModal"><i class="bi bi-plus-circle"></i> إضافة مؤهل</button>
                            </div>
                            @Html.Partial("~/Areas/Admin/Views/RegisteredTrainees/_QualificationList.cshtml", Model.Qualifications.ToList())
                            <hr class="my-4" />
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold m-0">المرفقات والوثائق</h6>
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addAttachmentModal"><i class="bi bi-cloud-upload"></i> رفع مرفق</button>
                            </div>
                            @Html.Partial("~/Areas/Admin/Views/RegisteredTrainees/_AttachmentList.cshtml", Model.Attachments.ToList())
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- العمود الأيسر -->
        <div class="col-lg-3">
            <!-- بطاقة المشرف -->
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-white fw-bold py-3 d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-briefcase me-2"></i> المشرف</span>
                    <button class="btn btn-sm btn-outline-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#supervisorSearchModal"><i class="bi bi-search"></i> تغيير</button>
                </div>
                <div class="card-body">
                    @if (Model.Supervisor != null)
                    {
                        <div class="text-center mb-3">
                            <img src="@(!string.IsNullOrEmpty(Model.Supervisor.PersonalPhotoPath) ? Url.Content(Model.Supervisor.PersonalPhotoPath) : "/Content/Images/default-avatar.png")"
                                 class="rounded-circle border p-1 mb-2" style="width: 70px; height: 70px; object-fit: cover;">
                            <h6 class="fw-bold mb-0">
                                <a href="@Url.Action("Details", "RegisteredTrainees", new { id = Model.Supervisor.Id })" target="_blank" class="text-decoration-none text-dark">@Model.Supervisor.ArabicName <i class="bi bi-box-arrow-up-right small text-muted ms-1"></i></a>
                            </h6>
                            <small class="text-muted">عضوية: @Model.Supervisor.Id</small>
                        </div>
                        <ul class="list-group list-group-flush small">
                            <li class="list-group-item d-flex justify-content-between"><span>الحالة:</span> <span class="badge bg-success">مزاول</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span>المزاولة:</span> <span>@Model.Supervisor.SubmissionDate.ToString("yyyy-MM-dd")</span></li>
                        </ul>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-person-x fs-1 d-block mb-2 opacity-50"></i>
                            لم يتم تعيين مشرف.<br><span class="small text-danger">مطلوب للاستمرار</span>
                            <div class="mt-3"><button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#supervisorSearchModal">اختيار مشرف</button></div>
                        </div>
                    }
                </div>
            </div>

            <!-- بطاقة الطباعة -->
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-white fw-bold"><i class="bi bi-printer me-2"></i> الطباعة</div>
                <div class="card-body d-grid gap-2">
                    <a href="@Url.Action("PrintIdCard", new { id = Model.Id })" target="_blank" class="btn btn-dark"><i class="bi bi-person-badge me-2"></i> بطاقة العضوية</a>
                    <a href="@Url.Action("PrintComprehensiveReport", new { id = Model.Id })" target="_blank" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-text me-2"></i> تقرير تفصيلي</a>
                    <a href="@Url.Action("PrintRegistrationCertificate", new { id = Model.Id })" target="_blank" class="btn btn-outline-secondary"><i class="bi bi-journal-check me-2"></i> شهادة قيد</a>
                </div>
            </div>

            <!-- ملاحظات سريعة -->
            <div class="card shadow-sm border-0 bg-warning bg-opacity-10">
                <div class="card-body">
                    <small class="text-muted fw-bold d-block mb-2">تنبيهات النظام:</small>
                    <ul class="ps-3 mb-0 small text-dark">
                        @if (suspensionDays > 0)
                        {
                            <li>يوجد أيام توقف تؤثر على تاريخ النهاية.</li>
}
                        @if (Model.Status == "متدرب موقوف")
                        {
                            <li class="text-danger fw-bold">المتدرب موقوف حالياً.</li>
}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals (Remain the same: councilSuspensionModal, addQualificationModal, addAttachmentModal, supervisorSearchModal) -->
<div class="modal fade" id="councilSuspensionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("CreateCouncilSuspension", "RegisteredTrainees", new { area = "Admin" }, FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                @Html.Hidden("TraineeId", Model.Id)
                <div class="modal-header bg-danger text-white"><h5 class="modal-title">تسجيل إيقاف</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="alert alert-warning small"><i class="bi bi-exclamation-triangle me-1"></i> سيتم خصم مدة الإيقاف من فترة التدريب.</div>
                    <div class="mb-3"><label class="form-label">السبب</label><textarea name="Reason" class="form-control" rows="2" required></textarea></div>
                    <div class="row g-2"><div class="col-6"><label class="form-label">من</label><input type="date" name="SuspensionStartDate" class="form-control" required value="@DateTime.Now.ToString("yyyy-MM-dd")"></div><div class="col-6"><label class="form-label">إلى</label><input type="date" name="SuspensionEndDate" class="form-control" required></div></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-danger">حفظ</button></div>
            }
        </div>
    </div>
</div>
@if (activeSuspension != null)
{
    <div class="modal fade" id="endSuspensionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                @using (Html.BeginForm("EndCouncilSuspension", "RegisteredTrainees", new { area = "Admin" }, FormMethod.Post))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="suspensionId" value="@activeSuspension.Id" />
                    <div class="modal-header bg-success text-white"><h5 class="modal-title">استئناف التدريب</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <div class="alert alert-info small"><i class="bi bi-info-circle me-1"></i> سيتم إنهاء الإيقاف الحالي وإعادة تفعيل المتدرب.</div>
                        <div class="mb-3"><label class="form-label fw-bold">تاريخ العودة للتدريب</label><input type="date" name="returnDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" required min="@activeSuspension.SuspensionStartDate.ToString("yyyy-MM-dd")" /></div>
                    </div>
                    <div class="modal-footer"><button type="submit" class="btn btn-success">تأكيد الاستئناف</button></div>
                }
            </div>
        </div>
    </div>
}
<div class="modal fade" id="addQualificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("AddQualification", "RegisteredTrainees", new { area = "Admin" }, FormMethod.Post))
            {@Html.AntiForgeryToken() @Html.Hidden("applicationId", Model.Id) <div class="modal-header"><h5 class="modal-title">إضافة مؤهل</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3">@if (ViewBag.QualificationTypes != null)
            {@Html.DropDownList("QualificationTypeId", (SelectList)ViewBag.QualificationTypes, new { @class = "form-select" })}</div><div class="row g-2"><div class="col-6 mb-3"><input type="text" name="UniversityName" class="form-control" placeholder="الجامعة" required></div><div class="col-6 mb-3"><input type="text" name="Faculty" class="form-control" placeholder="الكلية"></div><div class="col-6 mb-3"><input type="text" name="Specialization" class="form-control" placeholder="التخصص" required></div><div class="col-6 mb-3"><input type="number" name="GraduationYear" class="form-control" placeholder="سنة التخرج" required></div><div class="col-12 mb-3"><input type="number" step="0.01" name="GradePercentage" class="form-control" placeholder="المعدل"></div></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">حفظ</button></div>}
        </div>
    </div>
</div>
<div class="modal fade" id="addAttachmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("AddAttachment", "RegisteredTrainees", new { area = "Admin" }, FormMethod.Post, new { enctype = "multipart/form-data" }))
            {@Html.AntiForgeryToken() @Html.Hidden("applicationId", Model.Id) <div class="modal-header"><h5 class="modal-title">رفع وثيقة</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3">@if (ViewBag.AttachmentTypes != null)
            {@Html.DropDownList("AttachmentTypeId", (SelectList)ViewBag.AttachmentTypes, new { @class = "form-select" })}</div><div class="mb-3"><input type="file" name="UploadedFile" class="form-control" required /></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">رفع</button></div>}
        </div>
    </div>
</div>
<div class="modal fade" id="supervisorSearchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            @using (Html.BeginForm("AssignSupervisor", "RegisteredTrainees", new { area = "Admin" }, FormMethod.Post))
            {@Html.AntiForgeryToken() @Html.Hidden("applicationId", Model.Id) @Html.Hidden("supervisorId", "", new { id = "targetSupervisorId" }) <div class="modal-header bg-primary text-white"><h5 class="modal-title">تعيين مشرف</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="input-group mb-3"><input type="text" id="supervisorSearchInput" class="form-control" placeholder="ابحث بالاسم..."><button class="btn btn-primary" type="button" id="btnPerformSearch">بحث</button></div><div id="supervisorSearchResults" class="list-group" style="max-height: 300px; overflow-y: auto;"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button></div>}
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#btnPerformSearch').click(function () {
                var term = $('#supervisorSearchInput').val();
                var list = $('#supervisorSearchResults');
                if (term.length < 2) { alert("يرجى إدخال حرفين على الأقل."); return; }
                list.html('<div class="text-center py-3"><span class="spinner-border"></span></div>');
                // استخدام الأكشن المركزي للبحث
                $.get('@Url.Action("SearchSupervisors", "GraduateApplications", new { area = "Admin" })', { searchTerm: term }, function (data) {
                    list.empty();
                    if (data.success && data.supervisors.length > 0) {
                        $.each(data.supervisors, function (i, item) {
                            var itemHtml = item.isEligible ?
                                `<button type="submit" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="$('#targetSupervisorId').val(${item.id})"><div><strong>${item.name}</strong><br><small>${item.practiceDate}</small></div><span class="badge bg-success">اختيار</span></button>` :
                                `<div class="list-group-item list-group-item-light text-muted"><strong>${item.name}</strong> - <span class="text-danger">${item.ineligibilityReason}</span></div>`;
                            list.append(itemHtml);
                        });
                    } else { list.html('<div class="text-center text-danger py-3">لا توجد نتائج.</div>'); }
                });
            });
        });
    </script>
}