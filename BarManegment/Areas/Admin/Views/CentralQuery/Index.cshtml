@model BarManegment.Areas.Admin.ViewModels.CentralQueryViewModel
@using System.Linq
@{
    ViewBag.Title = "نظام الاستعلامات والتقارير المركزي";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    var stats = Model.Stats;
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" />
    <style>
        .stat-card {
            border-radius: 8px;
            border: 1px solid #eee;
            transition: transform 0.2s;
        }

            .stat-card:hover {
                transform: translateY(-3px);
            }
    </style>
}

<div class="container-fluid pt-4 px-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="m-0"><i class="bi bi-funnel-fill me-2"></i> @ViewBag.Title</h5>
        </div>
        <div class="card-body">

            @* ---------------------------------------------------------------------- *@
            @* 1. حقول التصفية والبحث *@
            @* ---------------------------------------------------------------------- *@
            @using (Html.BeginForm("Index", "CentralQuery", FormMethod.Get, new { @class = "p-3 mb-4 rounded border bg-light" }))
            {
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="searchTerm" class="form-label">بحث سريع (اسم/وطني/عضوية)</label>
                        <input type="text" name="searchTerm" class="form-control" value="@ViewBag.SearchTerm" />
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">الحالة</label>
                        @Html.DropDownList("status", Model.Statuses, "--- كل الحالات ---", new { @class = "form-select" })
                    </div>
                    <div class="col-md-3">
                        <label for="governorate" class="form-label">المحافظة</label>
                        @Html.DropDownList("governorate", Model.Governorates, "--- كل المحافظات ---", new { @class = "form-select" })
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-filter"></i> تصفية</button>
                    </div>
                </div>
                <div class="mt-3 form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="hasDebt" id="hasDebtCheck" value="true" @(ViewBag.CurrentDebt == "true" ? "checked" : "")>
                    <label class="form-check-label" for="hasDebtCheck">عرض المدينين بالقروض فقط</label>
                </div>
            }

            @* ---------------------------------------------------------------------- *@
            @* 2. البطاقات الإحصائية (Stats based on current filter) *@
            @* ---------------------------------------------------------------------- *@
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="p-3 bg-light text-center stat-card border-start border-3 border-primary">
                        <h6 class="text-muted mb-1">إجمالي السجلات</h6>
                        <h4 class="fw-bold text-primary">@stats.TotalRecords</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 bg-light text-center stat-card border-start border-3 border-success">
                        <h6 class="text-muted mb-1">محامي مزاول</h6>
                        <h4 class="fw-bold text-success">@stats.PracticingCount</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 bg-light text-center stat-card border-start border-3 border-info">
                        <h6 class="text-muted mb-1">متدرب مقيد</h6>
                        <h4 class="fw-bold text-info">@stats.TraineeCount</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 bg-light text-center stat-card border-start border-3 border-danger">
                        <h6 class="text-muted mb-1">باحث / مدين</h6>
                        <h4 class="fw-bold text-danger">@stats.DebtCount</h4>
                    </div>
                </div>
            </div>

            @* ---------------------------------------------------------------------- *@
            @* 3. زر التصدير والجدول *@
            @* ---------------------------------------------------------------------- *@
            <div class="d-flex justify-content-end mb-3">
                @using (Html.BeginForm("ExportToExcel", "CentralQuery", new { area = "Admin" }, FormMethod.Post, new { style = "display:inline;" }))
                {
                    <input type="hidden" name="status" value="@ViewBag.CurrentStatus" />
                    <input type="hidden" name="governorate" value="@ViewBag.CurrentGov" />
                    <input type="hidden" name="hasDebt" value="@ViewBag.CurrentDebt" />
                    <input type="hidden" name="searchTerm" value="@ViewBag.SearchTerm" />
                    <button type="submit" class="btn btn-success"><i class="bi bi-file-earmark-excel me-1"></i> تصدير البيانات المعروضة</button>
                }
            </div>

            <div class="table-responsive">
                <table id="applicationsTable" class="table table-striped table-hover align-middle" style="width:100%">
                    <thead>
                        <tr>
                            <th>#ID</th>
                            <th>الاسم الكامل</th>
                            <th>رقم العضوية</th>
                            <th>الرقم الوطني</th>
                            <th>الحالة المهنية</th>
                            <th>المحافظة</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Applications)
                        {
                            <tr>
                                <td>@item.Id</td>
                                <td>@item.ArabicName</td>
                                <td>@(item.MembershipId ?? "-")</td>
                                <td>@item.NationalIdNumber</td>
                                <td><span class="badge bg-secondary">@item.ApplicationStatus.Name</span></td>
                                <td>@(item.ContactInfo?.Governorate ?? "N/A")</td>
                                <td class="text-nowrap">
                                    @if (item.ApplicationStatus.Name.Contains("مزاول") || item.ApplicationStatus.Name.Contains("Advocate") || item.ApplicationStatus.Name.Contains("متقاعد"))
                                    {
                                        <a href="@Url.Action("Details", "LawyerProfile", new { id = item.Id })" class="btn btn-sm btn-outline-info" title="فتح ملف المحامي">
                                            <i class="bi bi-briefcase-fill"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <a href="@Url.Action("Details", "TraineeProfile", new { id = item.Id })" class="btn btn-sm btn-outline-info" title="فتح ملف المتدرب">
                                            <i class="bi bi-person-circle"></i>
                                        </a>
                                    }

                                    <a href="@Url.Action("ManageAttachments", "LawyerArchive", new { id = item.Id })" class="btn btn-sm btn-outline-primary" title="الأرشيف والمستندات">
                                        <i class="bi bi-folder"></i>
                                    </a>

                                    <a href="@Url.Action("ExportFinancialStatement", "OfficialReports", new { id = item.Id })" class="btn btn-sm btn-outline-success" title="تقرير مالي">
                                        <i class="bi bi-currency-dollar"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#applicationsTable').DataTable({
                "language": { "url": "https://cdn.datatables.net/plug-ins/1.13.8/i18n/ar.json" },
                "pageLength": 50,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "الكل"]],
                "searching": false, // تعطيل بحث DataTables الافتراضي لأننا نستخدم بحث السيرفر
                "order": [[0, 'desc']]
            });
        });
    </script>
}