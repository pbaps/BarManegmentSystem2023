@model BarManegment.Models.MonthlyPayroll

@{
    ViewBag.Title = $"مسير رواتب {Model.Month}/{Model.Year}";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid pt-4 px-4">

    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <div>
            <h4 class="text-primary fw-bold mb-0">
                <i class="bi bi-file-spreadsheet-fill me-2"></i> مسير رواتب شهر @Model.Month لسنة @Model.Year
            </h4>
            <span class="text-muted small">
                <i class="bi bi-clock"></i> تاريخ الإصدار: @Model.IssueDate.ToString("yyyy/MM/dd")
                | <i class="bi bi-person"></i> بواسطة: @Model.CreatedBy
            </span>
        </div>
        <div class="btn-group shadow-sm">
            <a href="@Url.Action("Print", new { id = Model.Id })" target="_blank" class="btn btn-outline-dark">
                <i class="bi bi-printer me-1"></i> طباعة رسمية
            </a>
            <a href="@Url.Action("Index")" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> عودة للقائمة
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="row align-items-center">

                <div class="col-md-3 text-center border-start bg-light py-3 rounded">
                    <h6 class="text-muted fw-bold mb-3">حالة المسير</h6>

                    @if (Model.IsPostedToJournal)
                    {
                        <div class="mb-3">
                            <span class="badge bg-success fs-6 px-3 py-2 w-100">
                                <i class="bi bi-check-circle-fill me-2"></i> معتمد ومرحل
                            </span>
                            <div class="mt-2 text-muted small font-monospace">
                                <i class="bi bi-hash"></i> رقم القيد:
                                <a href="@Url.Action("Details", "JournalEntries", new { id = Model.JournalEntryId })" class="text-decoration-none fw-bold">@Model.JournalEntryId</a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <span class="badge bg-warning text-dark fs-6 px-3 py-2 w-100 mb-2">
                                <i class="bi bi-hourglass-split me-2"></i> مسودة (قيد المراجعة)
                            </span>

                            <form action="@Url.Action("PostToJournal", new { id = Model.Id })" method="post" onsubmit="return confirm('تنبيه هام:\nهل أنت متأكد من اعتماد الرواتب وترحيل القيد المالي؟\nلا يمكن التراجع عن هذه الخطوة.');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-primary w-100 fw-bold shadow-sm">
                                    <i class="bi bi-check2-all me-1"></i> اعتماد وترحيل للمالية
                                </button>
                            </form>

                            <form action="@Url.Action("Delete", new { id = Model.Id })" method="post" onsubmit="return confirm('تحذير:\nهل أنت متأكد من حذف هذا المسير وجميع القسائم المرتبطة به؟');" class="mt-2">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                                    <i class="bi bi-trash me-1"></i> حذف المسير
                                </button>
                            </form>
                        </div>
                    }
                </div>

                <div class="col-md-9">
                    <div class="row text-center g-3">
                        <div class="col-md-4">
                            <div class="p-3 bg-white rounded border shadow-sm h-100">
                                <small class="d-block text-muted fw-bold text-uppercase mb-1">إجمالي الاستحقاق (Gross)</small>
                                <h3 class="text-primary fw-bold mb-0">@Model.TotalGrossAmount.ToString("N0")</h3>
                                <span class="text-muted small">@Model.PayrollSlips.Count موظف</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-white rounded border shadow-sm h-100">
                                <small class="d-block text-muted fw-bold text-uppercase mb-1">إجمالي الاستقطاعات</small>
                                <h3 class="text-danger fw-bold mb-0">@((Model.TotalGrossAmount - Model.TotalNetAmount).ToString("N0"))</h3>
                                <span class="text-danger small"><i class="bi bi-arrow-down"></i> خصومات وتأمين</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-success bg-opacity-10 rounded border border-success h-100 position-relative overflow-hidden">
                                <div class="position-absolute top-0 end-0 p-1">
                                    <i class="bi bi-wallet2 text-success opacity-25 fs-1"></i>
                                </div>
                                <small class="d-block text-success fw-bold text-uppercase mb-1">صافي الرواتب (Net Pay)</small>
                                <h3 class="text-success fw-bold mb-0">@Model.TotalNetAmount.ToString("N0")</h3>
                                <span class="text-success small fw-bold">المبلغ المستحق للصرف</span>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Notes))
                    {
                        <div class="alert alert-light border mt-3 mb-0 py-2 small text-muted">
                            <i class="bi bi-info-circle-fill me-2 text-info"></i> <strong>ملاحظات:</strong> @Model.Notes
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 border-bottom">
            <div class="row align-items-center">
                <div class="col">
                    <h6 class="mb-0 fw-bold text-dark"><i class="bi bi-people-fill me-2"></i> تفاصيل رواتب الموظفين</h6>
                </div>
                <div class="col-auto">
                    <input type="text" id="searchTable" class="form-control form-control-sm" placeholder="بحث باسم الموظف..." onkeyup="searchTable()">
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 600px;">
                <table class="table table-hover table-striped align-middle mb-0 text-center table-sm" id="payrollTable" style="font-size: 0.85rem;">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th class="text-start ps-3 py-2">الموظف</th>
                            <th class="py-2">الأساسي</th>
                            <th class="py-2">علاوات</th>
                            <th class="py-2">زيادة سنوية</th>
                            <th class="py-2">مواصلات</th>
                            <th class="bg-secondary text-white py-2">إجمالي الاستحقاق</th>
                            <th class="py-2">تقاعد (7%)</th>
                            <th class="py-2">خصومات أخرى</th>
                            <th class="bg-success text-white py-2">صافي الراتب</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var slip in Model.PayrollSlips)
                        {
                            <tr>
                                <td class="text-start ps-3">
                                    <div class="fw-bold">@slip.Employee.FullName</div>
                                    <span class="text-muted small">@slip.Employee.JobTitle?.Name</span>
                                </td>
                                <td>@slip.BasicSalary.ToString("N0")</td>
                                <td>@slip.AllowancesTotal.ToString("N0")</td>
                                <td>@slip.AnnualIncrementAmount.ToString("N0")</td>
                                <td>@slip.TransportAllowance.ToString("N0")</td>

                                <td class="fw-bold bg-light text-primary">@slip.GrossSalary.ToString("N0")</td>

                                <td class="text-danger">@slip.EmployeePensionDeduction.ToString("N0")</td>
                                <td class="text-danger">@slip.OtherDeductions.ToString("N0")</td>

                                <td class="fw-bold text-success bg-success bg-opacity-10 fs-6">@slip.NetSalary.ToString("N0")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-light fw-bold border-top border-2">
                        <tr>
                            <td class="text-start ps-3 py-3">المجموع الكلي</td>
                            <td>@Model.PayrollSlips.Sum(s => s.BasicSalary).ToString("N0")</td>
                            <td>@Model.PayrollSlips.Sum(s => s.AllowancesTotal).ToString("N0")</td>
                            <td>@Model.PayrollSlips.Sum(s => s.AnnualIncrementAmount).ToString("N0")</td>
                            <td>@Model.PayrollSlips.Sum(s => s.TransportAllowance).ToString("N0")</td>
                            <td class="text-primary">@Model.TotalGrossAmount.ToString("N0")</td>
                            <td class="text-danger">@Model.PayrollSlips.Sum(s => s.EmployeePensionDeduction).ToString("N0")</td>
                            <td class="text-danger">@Model.PayrollSlips.Sum(s => s.OtherDeductions).ToString("N0")</td>
                            <td class="bg-success text-white">@Model.TotalNetAmount.ToString("N0")</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // دالة بسيطة للبحث في الجدول
        function searchTable() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("searchTable");
            filter = input.value.toUpperCase();
            table = document.getElementById("payrollTable");
            tr = table.getElementsByTagName("tr");

            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[0]; // البحث في العمود الأول (الاسم)
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
    </script>
}