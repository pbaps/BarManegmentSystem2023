@model BarManegment.Models.MonthlyPayroll

@{
    ViewBag.Title = $"مسير رواتب {Model.Month}/{Model.Year}";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid pt-4 px-4">

    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <div>
            <h4 class="text-primary fw-bold mb-0">
                <i class="bi bi-file-spreadsheet-fill me-2"></i> مسير رواتب شهر @Model.Month لسنة @Model.Year
            </h4>
            <span class="text-muted small">تاريخ الإصدار: @Model.IssueDate.ToString("yyyy/MM/dd") | بواسطة: @Model.CreatedBy</span>
        </div>
        <div class="btn-group shadow-sm">
            <a href="@Url.Action("Print", new { id = Model.Id })" target="_blank" class="btn btn-outline-secondary">
                <i class="bi bi-printer me-1"></i> طباعة الكشف الرسمي
            </a>



            <a href="@Url.Action("Index")" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> عودة
            </a>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-3 text-center border-start">
                    <h6 class="text-muted fw-bold">الحالة المالية</h6>
                    @if (Model.IsPostedToJournal)
                    {
                        <span class="badge bg-success fs-6 px-3 py-2 mb-2"><i class="bi bi-check-circle-fill me-2"></i> مرحل للحسابات</span>
                        <br />
                        <small class="text-muted font-monospace">رقم القيد: #@Model.JournalEntryId</small>
                    }
                    else
                    {
                        <span class="badge bg-warning text-dark fs-6 px-3 py-2 mb-2"><i class="bi bi-hourglass-split me-2"></i> مسودة (غير مرحل)</span>

                        <form action="@Url.Action("PostToJournal", new { id = Model.Id })" method="post" onsubmit="return confirm('هل أنت متأكد من اعتماد الرواتب وترحيل القيد المالي؟ لا يمكن التراجع بعد هذه الخطوة.');">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-sm btn-primary w-100 mt-2">
                                <i class="bi bi-journal-check me-1"></i> اعتماد وترحيل للمالية
                            </button>
                        </form>

                        <form action="@Url.Action("Delete", new { id = Model.Id })" method="post" onsubmit="return confirm('هل أنت متأكد من حذف هذا المسير؟');" class="mt-1">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                                <i class="bi bi-trash me-1"></i> حذف المسير
                            </button>
                        </form>
                    }
                </div>

                <div class="col-md-9">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded border">
                                <small class="d-block text-muted fw-bold">إجمالي الاستحقاقات (Gross)</small>
                                <h4 class="text-primary fw-bold mb-0">@Model.TotalGrossAmount.ToString("N2")</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded border">
                                <small class="d-block text-muted fw-bold">إجمالي الاستقطاعات</small>
                                <h4 class="text-danger fw-bold mb-0">@((Model.TotalGrossAmount - Model.TotalNetAmount).ToString("N2"))</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-success bg-opacity-10 rounded border border-success">
                                <small class="d-block text-success fw-bold">صافي الرواتب (Net Pay)</small>
                                <h4 class="text-success fw-bold mb-0">@Model.TotalNetAmount.ToString("N2")</h4>
                            </div>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Notes))
                    {
                        <div class="alert alert-info mt-3 mb-0 py-2 small">
                            <i class="bi bi-info-circle me-2"></i> <strong>ملاحظات:</strong> @Model.Notes
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
            <h6 class="mb-0 fw-bold"><i class="bi bi-people me-2"></i> تفاصيل رواتب الموظفين</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle mb-0 text-center table-sm" style="font-size: 0.9rem;">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-start ps-3">الموظف</th>
                            <th>الأساسي</th>
                            <th>علاوات</th>
                            <th>زيادة سنوية</th>
                            <th>مواصلات</th>
                            <th class="bg-secondary text-white">إجمالي الاستحقاق</th>
                            <th>تقاعد (7%)</th>
                            <th>خصومات أخرى</th>
                            <th class="bg-success text-white">صافي الراتب</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var slip in Model.PayrollSlips)
                        {
                            <tr>
                                <td class="text-start ps-3 fw-bold">@slip.Employee.FullName</td>
                                <td>@slip.BasicSalary.ToString("N0")</td>
                                <td>@slip.AllowancesTotal.ToString("N0")</td>
                                <td>@slip.AnnualIncrementAmount.ToString("N0")</td>
                                <td>@slip.TransportAllowance.ToString("N0")</td>

                                <td class="fw-bold bg-light">@slip.GrossSalary.ToString("N2")</td>

                                <td class="text-danger">@slip.EmployeePensionDeduction.ToString("N2")</td>
                                <td class="text-danger">@slip.OtherDeductions.ToString("N2")</td>

                                <td class="fw-bold text-success bg-success bg-opacity-10">@slip.NetSalary.ToString("N2")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-light fw-bold">
                        <tr>
                            <td class="text-start ps-3">المجموع الكلي</td>
                            <td>@Model.PayrollSlips.Sum(s => s.BasicSalary).ToString("N0")</td>
                            <td>@Model.PayrollSlips.Sum(s => s.AllowancesTotal).ToString("N0")</td>
                            <td>@Model.PayrollSlips.Sum(s => s.AnnualIncrementAmount).ToString("N0")</td>
                            <td>@Model.PayrollSlips.Sum(s => s.TransportAllowance).ToString("N0")</td>
                            <td>@Model.TotalGrossAmount.ToString("N2")</td>
                            <td class="text-danger">@Model.PayrollSlips.Sum(s => s.EmployeePensionDeduction).ToString("N2")</td>
                            <td class="text-danger">@Model.PayrollSlips.Sum(s => s.OtherDeductions).ToString("N2")</td>
                            <td class="text-success">@Model.TotalNetAmount.ToString("N2")</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        @@media print {
            .no-print, header, footer, #sidebar {
                display: none !important;
            }

            .card {
                border: 1px solid #ddd !important;
            }

            .bg-light {
                background-color: #f8f9fa !important;
                -webkit-print-color-adjust: exact;
            }

            .table-dark {
                background-color: #212529 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
            }

            .bg-success {
                background-color: #d1e7dd !important;
                -webkit-print-color-adjust: exact;
            }
        }
    </style>
}
