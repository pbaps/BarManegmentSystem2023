@model BarManegment.Areas.Members.ViewModels.ComposeMessageViewModel
@{
    ViewBag.Title = Model.ParentMessageId.HasValue ? "الرد على رسالة" : "إنشاء رسالة جديدة";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<h2><i class="bi bi-pencil-square me-2"></i> @ViewBag.Title</h2>
<hr />

@using (Html.BeginForm("Compose", "Messaging", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()
    <div class="form-horizontal">
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        @* حقول مخفية لتتبع المرسل والرسالة الأصلية (في حالة الرد) *@
        @Html.HiddenFor(model => model.SenderId)
        @Html.HiddenFor(model => model.ParentMessageId)

        <div class="form-group mb-3">
            @Html.LabelFor(model => model.RecipientIdentifier, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @* إذا كان رداً، نعرض الاسم ونخفي حقل الإدخال *@
                @if (Model.ParentMessageId.HasValue && !string.IsNullOrEmpty(Model.RecipientNameDisplay))
                {
                    <p class="form-control-static fs-5 fw-bold">@Model.RecipientNameDisplay</p>
                    @Html.HiddenFor(model => model.RecipientIdentifier)
                }
                else
                {
                    @Html.EditorFor(model => model.RecipientIdentifier, new { htmlAttributes = new { @class = "form-control", placeholder = "أدخل الرقم الوطني أو رقم العضوية للمستلم" } })
                    @Html.ValidationMessageFor(model => model.RecipientIdentifier, "", new { @class = "text-danger" })
                }
            </div>
        </div>

        <div class="form-group mb-3">
            @Html.LabelFor(model => model.Subject, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.Subject, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.Subject, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group mb-3">
            @Html.LabelFor(model => model.Body, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.TextAreaFor(model => model.Body, new { @class = "form-control", rows = 8 })
                @Html.ValidationMessageFor(model => model.Body, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group mb-3">
            @Html.LabelFor(model => model.Files, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @* يجب أن يكون الاسم مطابقاً لاسم الخاصية في ViewModel (Files) *@
                <input type="file" name="Files" id="Files" multiple="multiple" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="submit" value="إرسال" class="btn btn-success" />
            </div>
        </div>
    </div>
}
<hr />
<div>
    @Html.ActionLink("العودة إلى صندوق الوارد", "Inbox")
</div>

