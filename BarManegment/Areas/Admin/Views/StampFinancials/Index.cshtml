@model IEnumerable<BarManegment.Areas.Admin.ViewModels.LawyerStampShareViewModel>
@{
    ViewBag.Title = "تقرير حصص المحامين (طوابع)";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<h2><i class="bi bi-bank2 me-2"></i> @ViewBag.Title</h2>
<p class="text-muted">
    يعرض هذا التقرير المبالغ الإجمالية المستحقة لكل محامي (التي ليست قيد الحجز) ضمن فترة زمنية محددة.
</p>

@* --- عرض رسائل النجاح أو الخطأ --- *@
@if (ViewBag.SuccessMessage != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @ViewBag.SuccessMessage

        @if (ViewBag.ReportUrl != null)
        {
            <a href="@ViewBag.ReportUrl" class="btn btn-warning btn-sm float-end me-5 fw-bold" download>
                <i class="bi bi-download me-1"></i> تحميل التقرير (Excel) الذي تم تأكيده
            </a>
        }
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Html.Raw(ViewBag.ErrorMessage)
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}


@* --- 1. نموذج تصفية التاريخ والتصدير --- *@
@using (Html.BeginForm("Index", "StampFinancials", FormMethod.Get, new { @class = "row g-3 mb-3 p-3 bg-light rounded border", id = "filterForm" }))
{
    <div class="col-md-3">
        <label for="from" class="form-label">من تاريخ (تاريخ البيع)</label>
        <input type="date" name="from" id="from" class="form-control" value="@ViewBag.FromDate" />
    </div>
    <div class="col-md-3">
        <label for="to" class="form-label">إلى تاريخ (تاريخ البيع)</label>
        <input type="date" name="to" id="to" class="form-control" value="@ViewBag.ToDate" />
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-info w-100">
            <i class="bi bi-filter"></i> تصفية
        </button>
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <a href="#" id="exportButton" class="btn btn-success w-100">
            <i class="bi bi-file-earmark-excel-fill me-1"></i> تصدير (للمراجعة قبل التأكيد)
        </a>
    </div>
}

<hr />

@* --- 2. نموذج تأكيد الإرسال للبنك --- *@
@using (Html.BeginForm("ConfirmTransfer", "StampFinancials", FormMethod.Post))
{
    @Html.AntiForgeryToken()

    <input type="hidden" name="from" value="@ViewBag.FromDate" />
    <input type="hidden" name="to" value="@ViewBag.ToDate" />

    <div class="mb-3 d-flex justify-content-between">
        <div>
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-check-circle-fill me-1"></i> تأكيد إرسال (المحدد) للبنك
            </button>
        </div>
        <div>
            @Html.ActionLink("عرض الأرشيف (المرسل سابقاً)", "History", null, new { @class = "btn btn-outline-secondary" })
            @Html.ActionLink("عرض الحصص المحجوزة", "HeldShares", null, new { @class = "btn btn-outline-warning" })
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-sm">
            <thead>
                <tr class="table-primary">
                    <th>
                        <input type="checkbox" id="checkAll" class="form-check-input" />
                    </th>
                    <th>@Html.DisplayNameFor(model => model.LawyerName)</th>

                    <th>@Html.DisplayNameFor(model => model.BankName)</th>
                    <th>@Html.DisplayNameFor(model => model.BankBranch)</th>
                    <th>@Html.DisplayNameFor(model => model.AccountNumber)</th>
                    <th>@Html.DisplayNameFor(model => model.Iban)</th>
                    <th>@Html.DisplayNameFor(model => model.TransactionCount)</th>
                    <th>@Html.DisplayNameFor(model => model.TotalAmount)</th>
                    <th>@Html.DisplayNameFor(model => model.CurrencySymbol)</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="10" class="text-center text-muted p-4">
                            لا يوجد أي حصص طوابع جاهزة للإرسال ضمن فترة التاريخ المحددة (أو جميعها محجوزة).
                        </td>
                    </tr>
                }

                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            <input type="checkbox" name="selectedLawyerIds" value="@item.LawyerId" class="form-check-input chk-lawyer" />
                        </td>
                        <td>@Html.DisplayFor(modelItem => item.LawyerName)</td>

                        <td>@Html.DisplayFor(modelItem => item.BankName)</td>
                        <td>@Html.DisplayFor(modelItem => item.BankBranch)</td>
                        <td>@Html.DisplayFor(modelItem => item.AccountNumber)</td>
                        <td>@Html.DisplayFor(modelItem => item.Iban)</td>
                        <td>@Html.DisplayFor(modelItem => item.TransactionCount)</td>
                        <td>@item.TotalAmount.ToString("N2")</td>
                        <td>@Html.DisplayFor(modelItem => item.CurrencySymbol)</td>
                        <td class="text-nowrap">
                            @* @Html.ActionLink("إدارة الحجوزات", "Manage", "StampShareManagement", new { id = item.LawyerId }, new { @class = "btn btn-sm btn-outline-warning" }) *@
                            <a href="@Url.Action("Edit", "GraduateApplications", new { area="Admin", id=item.LawyerId })" class="btn btn-sm btn-outline-primary" target="_blank" title="تعديل ملف المحامي (لإضافة بيانات البنك)">
                                <i class="bi bi-person-fill-gear"></i>
                            </a>
                            @Html.ActionLink("إدارة الحجوزات", "Manage", "StampShareManagement", new { id = item.LawyerId }, new { @class = "btn btn-sm btn-outline-warning" })
                        </td>
                    </tr>
                }
            </tbody>
            @if (Model.Any())
            {
                <tfoot class="table-light fw-bold fs-5">
                    <tr>
                        <td colspan="7" class="text-start">الإجمالي العام (للمعروض)</td>
                        <td>@Model.Sum(m => m.TransactionCount)</td>
                        <td>@Model.Sum(m => m.TotalAmount).ToString("N2")</td>
                        <td>@(Model.FirstOrDefault()?.CurrencySymbol)</td>
                        <td></td>
                    </tr>
                </tfoot>
            }
        </table>
    </div>
}

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            // (كود JavaScript لتحديد/إلغاء تحديد كل المربعات)
            $("#checkAll").click(function () {
                $(".chk-lawyer").prop('checked', $(this).prop('checked'));
            });

            // (كود تفعيل زر Excel)
            $('#exportButton').click(function (e) {
                e.preventDefault();
                var fromDate = $('#from').val();
                var toDate = $('#to').val();
                var baseUrl = '@Url.Action("ExportToExcel")';
                var url = baseUrl + '?from=' + encodeURIComponent(fromDate) + '&to=' + encodeURIComponent(toDate);
                window.location.href = url;
            });
        });
    </script>
}
