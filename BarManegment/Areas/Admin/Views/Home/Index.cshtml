@model BarManegment.Areas.Admin.ViewModels.AdminDashboardViewModel
@using BarManegment.Helpers
@using Newtonsoft.Json

@{
    ViewBag.Title = "لوحة القيادة المركزية";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";

    // === التحقق من الصلاحيات ===
    bool canManageGraduates = PermissionHelper.HasPermission("GraduateApplications");
    bool canManageFinance = PermissionHelper.HasPermission("Finance") || PermissionHelper.HasPermission("PaymentVouchers");
    bool canManageContracts = PermissionHelper.HasPermission("ContractTransactions");
    bool canManageStamps = PermissionHelper.HasPermission("StampInventory");
    bool canManageExams = PermissionHelper.HasPermission("Exams");
    bool isSuperAdmin = ViewBag.IsSuperAdmin != null && (bool)ViewBag.IsSuperAdmin;
}

<style>
    /* === 1. تنسيقات الشاشة (Screen Styles) === */
    :root {
        --card-radius: 12px;
    }
    .dashboard-container { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-bottom: 50px; }

    /* الكروت */
    .stat-card {
        border: none; border-radius: var(--card-radius); position: relative; overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 100%; background: #fff;
    }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .stat-card .card-body { padding: 1.5rem; z-index: 2; position: relative; }
    .stat-card .icon-bg {
        position: absolute; bottom: -15px; left: -15px; font-size: 6rem; opacity: 0.1;
        transform: rotate(15deg); z-index: 1; pointer-events: none;
    }

    /* ألوان الخلفيات (للشاشة فقط) */
    .bg-gradient-primary-custom { background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); color: white; }
    .bg-gradient-success-custom { background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%); color: white; }
    .bg-gradient-purple-custom  { background: linear-gradient(135deg, #6f42c1 0%, #4e2a84 100%); color: white; }
    .bg-gradient-info-custom    { background: linear-gradient(135deg, #36b9cc 0%, #258391 100%); color: white; }

    /* الوصول السريع */
    .quick-action-card {
        border: 1px solid #e3e6f0; border-radius: 12px; background: white; padding: 15px; text-align: center;
        transition: 0.3s; display: block; text-decoration: none; color: #5a5c69; height: 100%;
    }
    .quick-action-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); color: #4e73df; }
    .quick-action-icon { font-size: 1.5rem; margin-bottom: 10px; }

    /* ترويسة التقرير (مخفية في الشاشة) */
    #print-header { display: none; }

    /* === 2. تنسيقات الطباعة (Print Styles) - هذا ما يحل مشكلتك === */
    @@media print {
        /* إخفاء العناصر غير الضرورية */
        .no-print, .sidebar, .navbar, footer, .btn, .quick-action-card, .alert-warning {
            display: none !important;
        }

        /* ضبط الصفحة */
        body, .dashboard-container, .container-fluid {
            background-color: white !important;
            margin: 0 !important; padding: 0 !important; width: 100% !important;
        }

        /* إظهار ترويسة التقرير */
        #print-header {
            display: flex !important;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* تحويل الكروت الملونة إلى مربعات نصية رسمية */
        .stat-card {
            border: 1px solid #000 !important;
            box-shadow: none !important;
            background: white !important;
            color: black !important;
            page-break-inside: avoid;
            margin-bottom: 15px;
        }

        .stat-card .card-body { padding: 10px !important; }

        /* إخفاء الأيقونات الخلفية وألوان النصوص */
        .icon-bg { display: none !important; }
        .text-white-50 { color: #555 !important; }
        .text-primary, .text-success, .text-purple, .text-info { color: #000 !important; }

        /* تنظيم الشبكة (Grid) للطباعة */
        .row { display: flex !important; flex-wrap: wrap !important; }
        .col-md-6, .col-xl-3 {
            width: 50% !important;
            flex: 0 0 50% !important;
            max-width: 50% !important;
            padding: 5px !important;
        }

        /* الرسوم البيانية */
        .chart-container {
            border: 1px solid #ccc;
            page-break-inside: avoid;
        }
    }
</style>

<div class="dashboard-container">

    <div id="print-header">
        <div>
            <h2 style="margin:0; font-weight:bold;">نقابة المحامين الفلسطينيين</h2>
            <p style="margin:0;">تقرير الأداء اليومي</p>
        </div>
        <div style="text-align:left;">
            <p style="margin:0;">التاريخ: @DateTime.Now.ToString("yyyy/MM/dd")</p>
            <p style="margin:0;">الوقت: @DateTime.Now.ToString("HH:mm")</p>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4 pt-3 no-print">
        <div>
            <h3 class="fw-bold text-dark mb-1">👋 مرحباً، @(Session["FullName"] ?? "المستخدم")</h3>
            <p class="text-muted mb-0">نظرة عامة على النظام اليوم.</p>
        </div>
        <div>
            <button onclick="window.print()" class="btn btn-dark shadow-sm">
                <i class="bi bi-printer-fill me-2"></i> طباعة تقرير
            </button>
        </div>
    </div>

    @if (Model.DueChecksCount > 0 && canManageFinance)
    {
        <div class="alert alert-warning shadow-sm border-warning d-flex align-items-center mb-4 no-print" role="alert">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
                <strong>تنبيه مالي:</strong> لديك <span class="fw-bold">@Model.DueChecksCount</span> شيكات مستحقة التحصيل.
                <a href="@Url.Action("Index", "CheckPortfolio", new { area = "Admin" })" class="alert-link ms-1">متابعة</a>
            </div>
        </div>
    }

    <h6 class="text-muted fw-bold mb-3 small no-print">المؤشرات الرئيسية</h6>
    <div class="row g-3 mb-4">

        @if (canManageFinance)
        {
            <div class="col-xl-3 col-md-6">
                <div class="stat-card bg-gradient-success-custom">
                    <div class="card-body">
                        <h6 class="opacity-75 fw-bold mb-2">الإيراد اليومي</h6>
                        <h3 class="fw-bold mb-0">@Model.TotalRevenueToday.ToString("N0") <small style="font-size:0.6em">₪</small></h3>
                        <small class="opacity-75 mt-2 d-block">
                            عدد السندات غير المدفوعة: @Model.UnpaidVouchersCount
                        </small>
                    </div>
                    <i class="bi bi-currency-exchange icon-bg"></i>
                </div>
            </div>
        }

        @if (canManageGraduates)
        {
            <div class="col-xl-3 col-md-6">
                <div class="stat-card bg-gradient-primary-custom">
                    <div class="card-body">
                        <h6 class="opacity-75 fw-bold mb-2">المحامين المزاولين</h6>
                        <h3 class="fw-bold mb-0">@Model.PracticingLawyersCount</h3>
                        <small class="opacity-75 mt-2 d-block">
                            + @Model.ActiveTraineesCount متدرب مقيد
                        </small>
                    </div>
                    <i class="bi bi-people-fill icon-bg"></i>
                </div>
            </div>
        }

        @if (canManageContracts)
        {
            <div class="col-xl-3 col-md-6">
                <div class="stat-card bg-gradient-purple-custom">
                    <div class="card-body">
                        <h6 class="opacity-75 fw-bold mb-2">عقود قيد التصديق</h6>
                        <h3 class="fw-bold mb-0">@Model.PendingContractsCount</h3>
                        <small class="opacity-75 mt-2 d-block">
                            معاملات جارية حالياً
                        </small>
                    </div>
                    <i class="bi bi-file-earmark-text-fill icon-bg"></i>
                </div>
            </div>
        }

        @if (canManageStamps)
        {
            <div class="col-xl-3 col-md-6">
                <div class="stat-card bg-gradient-info-custom">
                    <div class="card-body">
                        <h6 class="opacity-75 fw-bold mb-2">مخزون الطوابع</h6>
                        <h3 class="fw-bold mb-0">@Model.AvailableStampsCount</h3>
                        <small class="opacity-75 mt-2 d-block">
                            طابع جاهز للبيع
                        </small>
                    </div>
                    <i class="bi bi-postcard-heart-fill icon-bg"></i>
                </div>
            </div>
        }
    </div>

    <div class="no-print mb-4">
        <h6 class="text-muted fw-bold mb-3 small">وصول سريع</h6>
        <div class="row g-3">
            @if (canManageFinance)
            {
                <div class="col-6 col-md-2">
                    <a href="@Url.Action("SelectTrainee", "PaymentVouchers", new { area = "Admin" })" class="quick-action-card">
                        <div class="quick-action-icon text-success"><i class="bi bi-cash-coin"></i></div>
                        <span class="fw-bold small">قبض رسوم</span>
                    </a>
                </div>
            }
            @if (canManageContracts)
            {
                <div class="col-6 col-md-2">
                    <a href="@Url.Action("Create", "ContractTransactions", new { area = "Admin" })" class="quick-action-card">
                        <div class="quick-action-icon text-purple" style="color:#6f42c1"><i class="bi bi-pen"></i></div>
                        <span class="fw-bold small">توثيق عقد</span>
                    </a>
                </div>
            }
            @if (canManageStamps)
            {
                <div class="col-6 col-md-2">
                    <a href="@Url.Action("RecordSale", "StampSales", new { area = "Admin" })" class="quick-action-card">
                        <div class="quick-action-icon text-info"><i class="bi bi-cart"></i></div>
                        <span class="fw-bold small">بيع طوابع</span>
                    </a>
                </div>
            }
            @if (canManageGraduates)
            {
                <div class="col-6 col-md-2">
                    <a href="@Url.Action("Create", "GraduateApplications", new { area = "Admin" })" class="quick-action-card">
                        <div class="quick-action-icon text-primary"><i class="bi bi-person-plus"></i></div>
                        <span class="fw-bold small">عضو جديد</span>
                    </a>
                </div>
            }
            @if (canManageFinance)
            {
                <div class="col-6 col-md-2">
                    <a href="@Url.Action("Index", "CheckPortfolio", new { area = "Admin" })" class="quick-action-card">
                        <div class="quick-action-icon text-warning"><i class="bi bi-wallet2"></i></div>
                        <span class="fw-bold small">الشيكات</span>
                    </a>
                </div>
            }
            <div class="col-6 col-md-2">
                <a href="@Url.Action("Index", "Users", new { area = "Admin" })" class="quick-action-card">
                    <div class="quick-action-icon text-secondary"><i class="bi bi-gear"></i></div>
                    <span class="fw-bold small">الإعدادات</span>
                </a>
            </div>
        </div>
    </div>

    <div class="row g-4">
        @if (isSuperAdmin)
        {
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100 chart-container">
                    <div class="card-header bg-white border-0 py-3 no-print">
                        <h6 class="fw-bold mb-0">نمو الأعضاء</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="growthChart" style="max-height: 300px; width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        }

        <div class="@(isSuperAdmin ? "col-lg-4" : "col-12")">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="fw-bold mb-0">آخر النشاطات</h6>
                </div>
                <div class="card-body p-0">
                    @if (Model.RecentActivities != null && Model.RecentActivities.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var log in Model.RecentActivities)
                            {
                                <li class="list-group-item border-0 d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="fw-bold d-block">@log.Action</small>
                                        <small class="text-muted" style="font-size:0.75rem">@log.User?.FullNameArabic</small>
                                    </div>
                                    <span class="badge bg-light text-dark fw-normal border">@log.Timestamp.ToString("HH:mm")</span>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-center text-muted py-3 small">لا توجد نشاطات</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="d-none d-print-block mt-5 pt-4 border-top text-center text-muted small">
        تم استخراج هذا التقرير من النظام الإلكتروني لنقابة المحامين - @DateTime.Now.ToString("yyyy/MM/dd HH:mm")
    </div>
</div>

@section Scripts {
    @if (isSuperAdmin)
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            $(document).ready(function () {
                Chart.defaults.font.family = "'Cairo', sans-serif";

                var historyData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.HistoricalData));
                if (!historyData || historyData.length === 0) {
                    historyData = [{Year:2023, LawyerCount:100, TraineeCount:50}, {Year:2024, LawyerCount:120, TraineeCount:60}];
                }

                new Chart(document.getElementById('growthChart'), {
                    type: 'line',
                    data: {
                        labels: historyData.map(d => d.Year),
                        datasets: [
                            {
                                label: 'المحامون',
                                data: historyData.map(d => d.LawyerCount),
                                borderColor: '#4e73df',
                                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                                tension: 0.3, fill: true
                            },
                            {
                                label: 'المتدربون',
                                data: historyData.map(d => d.TraineeCount),
                                borderColor: '#1cc88a',
                                backgroundColor: 'rgba(28, 200, 138, 0.1)',
                                tension: 0.3, fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            });
        </script>
    }
}