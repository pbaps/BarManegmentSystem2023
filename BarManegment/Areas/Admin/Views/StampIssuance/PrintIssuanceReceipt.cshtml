@model BarManegment.Areas.Admin.ViewModels.StampIssuanceReceiptViewModel
@using BarManegment.Helpers

@{
    ViewBag.Title = "إيصال صرف طوابع رقم " + Model.ReceiptFullNumber;
    Layout = null; // يفضل Layout = null للطباعة
    string applicantTitle = "السيد";
    string tafqeetResult = Model.TotalAmountInWords;
}

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>@ViewBag.Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* تصحيح: استخدام @@ لتهريب الرمز في Razor */
        @@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #525659;
            margin: 0;
            padding: 20px;
        }

        .page-container {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 10mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            box-sizing: border-box;
        }

        .receipt-copy {
            border: 1px dashed #777;
            padding: 20px;
            margin-bottom: 10mm;
            page-break-inside: avoid;
            display: flex;
            flex-direction: column;
            min-height: 8cm;
            position: relative;
        }

            .receipt-copy:last-child {
                margin-bottom: 0;
            }

        .receipt-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #d90000;
            padding-bottom: 10px;
        }

        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

            .logo-container img {
                max-height: 70px;
                margin-left: 15px;
            }

        .title-text {
            font-size: 1.6rem;
            font-weight: 800;
            margin: 0;
            color: #d90000;
        }

        .subtitle-text {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
            color: #333;
            letter-spacing: 1px;
        }

        .receipt-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }

        .copy-name {
            font-weight: bold;
            background-color: #333;
            color: white;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .receipt-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #d90000;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .info-item {
            border-bottom: 1px dotted #ccc;
            padding-bottom: 3px;
        }

            .info-item strong {
                display: inline-block;
                width: 100px;
                color: #555;
            }

        .amount-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

            .details-table th, .details-table td {
                border: 1px solid #dee2e6;
                padding: 8px;
                text-align: center;
            }

            .details-table th {
                background-color: #f1f1f1;
            }

        .footer-signatures {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 20px;
        }

        .sig-box {
            text-align: center;
            width: 30%;
        }

        .sig-line {
            border-bottom: 1px dotted #000;
            height: 30px;
            margin-bottom: 5px;
        }

        /* تنسيقات الطباعة */
        @@media print {
            body {
                background: none;
                padding: 0;
                margin: 0;
            }

            .page-container {
                box-shadow: none;
                width: 100%;
                padding: 5mm;
                margin: 0;
            }

            .no-print {
                display: none !important;
            }

            .receipt-copy {
                border: 1px solid #000;
                margin-bottom: 5mm;
            }
        }
    </style>
</head>
<body>

    <div class="text-center mb-4 no-print">
        <button onclick="window.print()" class="btn btn-primary btn-lg shadow">طباعة الإيصال</button>
        <button onclick="window.close()" class="btn btn-secondary btn-lg ms-2">إغلاق</button>
    </div>

    <div class="page-container">
        @RenderReceiptBody($"النسخة الأصلية - {applicantTitle}", tafqeetResult, applicantTitle, Model)
        @RenderReceiptBody("نسخة ثانية - للمحاسبة", tafqeetResult, applicantTitle, Model)
        @RenderReceiptBody("نسخة ثالثة - للملف", tafqeetResult, applicantTitle, Model)
    </div>

    @helper RenderReceiptBody(string copyName, string tafqeetText, string title, BarManegment.Areas.Admin.ViewModels.StampIssuanceReceiptViewModel vm)
    {
        <div class="receipt-copy">
            <div class="receipt-header">
                <div class="logo-container">
                    <img src="/Content/Images/logo.png" alt="Logo" onerror="this.style.display='none'" />
                    <div>
                        <h2 class="title-text">نقابة المحامين الفلسطينيين</h2>
                        <p class="subtitle-text">PALESTINIAN BAR ASSOCIATION</p>
                    </div>
                </div>
                <div>إيصال قبض (صرف طوابع)</div>
            </div>

            <div class="receipt-info-bar">
                <span class="copy-name">@copyName</span>
                <span class="receipt-number">رقم: @vm.ReceiptFullNumber</span>
                <span>التاريخ: @vm.PaymentDate.ToString("yyyy/MM/dd")</span>
            </div>

            <div class="info-grid">
                <div class="info-item"><strong>استلمنا من:</strong> @vm.ContractorName</div>
                <div class="info-item"><strong>بواسطة:</strong> @vm.IssuedByUserName</div>
                <div class="info-item" style="grid-column: span 2;"><strong>طريقة الدفع:</strong> نقداً (حساب الطوابع)</div>
            </div>

            <div class="amount-box">
                مبلغاً وقدره: @vm.TotalAmount.ToString("N2") @vm.CurrencySymbol <br />
                <span class="fw-normal">(@tafqeetText فقط لا غير)</span>
            </div>

            <table class="details-table">
                <thead>
                    <tr>
                        <th>البيان / تفاصيل الدفاتر</th>
                        <th width="25%">المبلغ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in vm.Details)
                    {
                        <tr>
                            <td class="text-end pe-3">@item.Description</td>
                            <td>@item.Amount.ToString("N2")</td>
                        </tr>
                    }
                    <tr class="fw-bold bg-light">
                        <td class="text-end pe-3">المجموع</td>
                        <td>@vm.TotalAmount.ToString("N2") @vm.CurrencySymbol</td>
                    </tr>
                </tbody>
            </table>

            <div class="footer-signatures">
                <div class="sig-box">
                    <strong>المستلم (@title)</strong>
                    <div class="sig-line"></div>
                    <small>@vm.ContractorName</small>
                </div>
                <div class="sig-box">
                    <strong>الختم الرسمي</strong>
                    <br><br>
                </div>
                <div class="sig-box">
                    <strong>أمين الصندوق</strong>
                    <div class="sig-line"></div>
                    <small>(@vm.IssuedByUserName)</small>
                </div>
            </div>
        </div>
    }

</body>
</html>