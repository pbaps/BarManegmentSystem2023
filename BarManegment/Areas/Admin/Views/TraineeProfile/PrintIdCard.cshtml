@model BarManegment.Areas.Admin.ViewModels.TraineeIdCardViewModel
@{
    Layout = null;
    string photoUrl = !string.IsNullOrEmpty(Model.PersonalPhotoPath)
                      ? Url.Content(Model.PersonalPhotoPath)
                      : Url.Content("~/Content/Images/default-avatar.png");
}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>طباعة بطاقة متدرب: @Model.TraineeName</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    @* === إضافة مكتبة QRious لتوليد QR Code === *@
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

    <style>

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #eee;
            display: flex;
            /* (تعديل بسيط) وضع البطاقات بجانب بعضها في العرض العادي */
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap; /* للسماح للبطاقات بالالتفاف */
            min-height: 100vh;
            padding-top: 30px;
        }

        .print-controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .card-container {
            width: 323px;
            height: 204px;
            position: relative;
            margin: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background-color: #fff;
            flex-shrink: 0; /* (إضافة) لمنع الانكماش */
        }

        .id-card-front, .id-card-back {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            padding: 15px;
            box-sizing: border-box;
            background-color: #fff;
            color: #333;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* (كل تنسيقات الواجهة الأمامية والخلفية التي كتبناها سابقاً تبقى كما هي) */
        :root {
            --primary-color: #0A4D68;
            --secondary-color: #088395;
            --accent-color: #F3B400;
            --text-color: #333333;
            --light-bg: #F8F9FA;
        }

        .id-card-front {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .id-card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
            padding-bottom: 8px;
        }

            .id-card-header::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 15%;
                right: 15%;
                height: 2px;
                background-color: rgba(255,255,255,0.4);
                border-radius: 2px;
            }

        .id-card-logo {
            height: 38px;
            margin-left: 5px;
        }

        .header-title {
            text-align: center;
            flex-grow: 1;
            margin-right: 10px;
        }

            .header-title h6 {
                margin: 0;
                font-size: 0.9rem;
                font-weight: 700;
                color: #fff;
            }

            .header-title p {
                margin: 0;
                font-size: 0.7rem;
                color: #dee2e6;
            }

        .id-card-body {
            display: flex;
            flex-grow: 1;
            margin-top: 10px;
            color: #fff;
        }

        .photo-section {
            width: 85px;
            margin-left: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }

        .photo {
            width: 80px;
            height: 95px;
            border: 2px solid rgba(255,255,255,0.6);
            object-fit: cover;
            margin-bottom: 5px;
            background-color: #fff;
            border-radius: 5px;
        }

        .serial-no {
            font-size: 0.7rem;
            font-weight: bold;
            color: var(--accent-color);
            background-color: rgba(0,0,0,0.2);
            padding: 2px 5px;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            text-align: center; /* (تعديل من المرة السابقة) */
        }

        .info-section {
            flex-grow: 1;
            font-size: 0.68rem;
            line-height: 1.3; /* (تعديل من المرة السابقة) */
        }

            .info-section strong {
                display: inline-block;
                min-width: 70px;
                font-weight: 600;
                color: rgba(255,255,255,0.8);
            }

            .info-section span {
                color: #fff;
                font-weight: 500;
            }

            .info-section p {
                margin-bottom: 0px;
            }

        .id-card-back {
            background-color: var(--light-bg);
            color: var(--text-color);
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .qr-code-section {
            text-align: center;
            margin-bottom: 10px;
        }

        #qrcodeCanvas {
            border: 1px solid #ccc;
            padding: 5px;
            background-color: #fff;
            border-radius: 5px;
            width: 100px;
            height: 100px;
        }

        .facilitation-text {
            font-size: 0.65rem;
            text-align: center;
            color: #555;
            padding: 0 10px;
            line-height: 1.3;
        }

            .facilitation-text strong {
                color: var(--primary-color);
            }

        .signature-section {
            font-size: 0.6rem;
            text-align: center;
            margin-top: auto;
            color: #666;
            width: 100%;
        }

            .signature-section .line {
                display: block;
                width: 80px;
                height: 1px;
                background-color: #888;
                margin: 5px auto;
            }

        /* ===
        ===  بداية التعديلات الهامة للطباعة (لحل مشكلة القص)
        === */
        @@media print {
            /* 1. التحكم بحجم وهوامش الصفحة */
            @@page {
                size: A4 portrait; /* تحديد حجم الورق */
                margin: 0mm; /* إزالة هوامش المتصفح بالكامل */
            }
            /* 2. إعادة تعيين الجسم (Body) للطباعة */
            html, body {
                width: 210mm;
                height: 297mm;
                background-color: #fff;
                padding-top: 0;
                display: block;
                margin: 0;
                padding: 0;
            }
            /* 3. إخفاء أزرار التحكم */
            .print-controls {
                display: none;
            }
            /* 4. إعداد حاويات البطاقات للطباعة */
            .card-container {
                box-shadow: none;
                border: none;
                margin: 10mm; /* وضع هامش 1سم حول كل بطاقة للقص */
                page-break-after: always; /* (الأهم) كل بطاقة في صفحة منفصلة */
                page-break-inside: avoid;
            }
            /* 5. إظهار البطاقتين (اللتين كانتا 'absolute') */
            .id-card-front, .id-card-back {
                position: relative;
                border: 1px dashed #888; /* إضافة حد متقطع للمساعدة في القص */
            }
            /* 6. التأكد من ظهور ألوان الخلفية والشعار */
            .id-card-front {
                background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
                -webkit-print-color-adjust: exact; /* لضمان طباعة الألوان */
                color-adjust: exact;
            }

            .id-card-logo {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }
        /* === نهاية التعديلات === */
    </style>
</head>
<body>

    <div class="print-controls">
        <button class="btn btn-sm btn-primary" onclick="window.print();">طباعة</button>
        <button class="btn btn-sm btn-secondary" onclick="window.close();">إغلاق</button>
    </div>

    @* الواجهة الأمامية للبطاقة *@
    <div class="card-container">
        <div class="id-card-front">
            <div class="id-card-header">
                <img src="@Url.Content("~/Content/Images/logo.png")" alt="شعار النقابة" class="id-card-logo" />



                <div class="header-title">
                    <h6>نقابة المحامين الفلسطينيين</h6>
                    <p>
                        بطاقة محامي متدرب

                    </p>
                </div>

            </div>

            <div class="id-card-body">

                <div class="photo-section">

                    <img src="@photoUrl" alt="الصورة الشخصية" class="photo" />

                </div>
                <div class="info-section">

                    <p><strong>الاسم:</strong> <span>@Model.TraineeName</span></p>
                    <p><strong>رقم الهوية:</strong> <span>@Model.NationalIdNumber</span></p>
                    <p><strong>رقم المتدرب:</strong> <span>@Model.TraineeSerialNo</span></p>
                    <p><strong>المحافظة:</strong> <span>@Model.Governorate</span></p>
                    <p><strong>المشرف:</strong> <span>@Model.SupervisorName</span></p>
                    <p><strong>الحالة:</strong> <span>@Model.ProfessionalStatus</span></p>
                    <p><strong>بدء التدريب:</strong> <span>@(Model.TrainingStartDate?.ToString("yyyy/MM/dd"))</span></p>

                </div>
            </div>
        </div>
    </div>

    @* الواجهة الخلفية للبطاقة *@
    <div class="card-container">
        <div class="id-card-back">
            <div class="qr-code-section">
                <canvas id="qrcodeCanvas"></canvas>
                <p class="mt-1" style="font-size:0.6rem; color:#666;">امسح للكشف عن تفاصيل المتدرب</p>
            </div>
            <div class="facilitation-text">
                <p>
                    تطلب <strong>نقابة المحامين الفلسطينيين</strong> من كافة الجهات الرسمية وغير الرسمية
                    <strong>تسهيل مهمة حامل هذه البطاقة</strong> كونه محامياً متدرباً لديها.
                </p>
            </div>
            <div class="signature-section">
                <span class="line"></span>
                <p>نقيب المحامين</p>
            </div>
        </div>
    </div>

    <script>
        // دالة لتوليد QR Code
        function generateQRCode() {
            var qrdata = '@Html.Raw(Model.QRCodeData)'; // استخدم Html.Raw لتجنب تشفير HTML
            var canvas = document.getElementById('qrcodeCanvas');

            if (canvas && qrdata) {
                new QRious({
                    element: canvas,
                    value: qrdata,
                    size: 100, // حجم الـ QR Code بالبكسل
                    level: 'H' // مستوى تصحيح الخطأ (L, M, Q, H)
                });
            } else {
                console.error("QR Code canvas or data not found.");
            }
        }

        // استدعاء دالة توليد QR Code عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', generateQRCode);
    </script>
</body>
</html>