@model PagedList.IPagedList<BarManegment.Models.JournalEntry>
@using PagedList.Mvc;

@{
    ViewBag.Title = "قيود اليومية";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<style>
    /* تنسيق ترقيم الصفحات */
    .pagination-container {
        text-align: center;
        margin-top: 20px;
    }

    .pagination {
        justify-content: center;
        display: flex;
        padding-left: 0;
        list-style: none;
    }

        .pagination .page-item .page-link, .pagination .page-item a {
            position: relative;
            display: block;
            padding: 0.5rem 0.75rem;
            margin-left: -1px;
            line-height: 1.25;
            color: #4e73df;
            background-color: #fff;
            border: 1px solid #dddfeb;
            text-decoration: none;
        }

        .pagination .page-item.active .page-link, .pagination .page-item.active a {
            z-index: 1;
            color: #fff;
            background-color: #4e73df;
            border-color: #4e73df;
        }

        .pagination .page-item:first-child a {
            border-top-right-radius: 0.35rem;
            border-bottom-right-radius: 0.35rem;
        }

        .pagination .page-item:last-child a {
            border-top-left-radius: 0.35rem;
            border-bottom-left-radius: 0.35rem;
        }

    /* ستايل مؤشر الترتيب */
    .sort-header {
        cursor: pointer;
        transition: background 0.2s;
        position: relative;
    }

        .sort-header:hover {
            background-color: #f8f9fc !important;
        }

    .sort-icon {
        font-size: 0.8rem;
        margin-right: 5px;
        color: #ccc;
    }

    .sort-active {
        color: #4e73df !important;
    }
</style>

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-primary text-white">
        <h5 class="m-0 fw-bold"><i class="bi bi-journals me-2"></i> سجل قيود اليومية (General Ledger)</h5>
        @if (BarManegment.Helpers.PermissionHelper.HasPermission("FinancialReports"))
        {
            <a href="@Url.Action("Create")" class="btn btn-light text-primary btn-sm fw-bold shadow-sm">
                <i class="bi bi-plus-circle-fill"></i> قيد يدوي جديد
            </a>
        }
    </div>
    <div class="card-body">

        @using (Html.BeginForm("Index", "JournalEntries", FormMethod.Get, new { @class = "row g-3 mb-4 align-items-end" }))
        {
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted">بحث شامل</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" name="searchString" value="@ViewBag.CurrentFilter" class="form-control" placeholder="رقم القيد / المرجع / البيان..." />
                </div>
            </div>

            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted">المصدر</label>
                <select name="sourceFilter" class="form-select">
                    <option value="">-- الكل --</option>
                    <option value="Manual" @(ViewBag.SourceFilter == "Manual" ? "selected" : "")>قيد يدوي</option>
                    <option value="Receipts" @(ViewBag.SourceFilter == "Receipts" ? "selected" : "")>سندات قبض</option>
                    <option value="GeneralExpenses" @(ViewBag.SourceFilter == "GeneralExpenses" ? "selected" : "")>مصروفات</option>
                    <option value="OpeningBalance" @(ViewBag.SourceFilter == "OpeningBalance" ? "selected" : "")>رصيد افتتاحي</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted">من تاريخ</label>
                <input type="date" name="fromDate" value="@ViewBag.FromDate" class="form-control" />
            </div>

            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted">إلى تاريخ</label>
                <input type="date" name="toDate" value="@ViewBag.ToDate" class="form-control" />
            </div>

            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-filter"></i> عرض النتائج</button>
            </div>
        }

        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle" id="journalTable" width="100%" cellspacing="0">
                <thead class="table-light text-dark text-nowrap">
                    <tr>
                        <th onclick="sortTable(0)" class="sort-header" style="width: 12%">رقم القيد <i class="bi bi-arrow-down-up sort-icon"></i></th>
                        <th onclick="sortTable(1)" class="sort-header" style="width: 10%">التاريخ <i class="bi bi-arrow-down-up sort-icon"></i></th>
                        <th onclick="sortTable(2)" class="sort-header" style="width: 12%">المصدر <i class="bi bi-arrow-down-up sort-icon"></i></th>
                        <th onclick="sortTable(3)" class="sort-header" style="width: 30%">البيان <i class="bi bi-arrow-down-up sort-icon"></i></th>
                        <th onclick="sortTable(4)" class="sort-header" style="width: 15%">الإجمالي <i class="bi bi-arrow-down-up sort-icon"></i></th>
                        <th style="width: 10%">السنة المالية</th>
                        <th style="width: 10%">الحالة</th>
                        <th style="width: 8%" class="text-center no-sort">إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="fw-bold text-center font-monospace">
                                <a href="@Url.Action("Details", new { id = item.Id })" class="text-decoration-none">#@item.EntryNumber</a>
                            </td>
                            <td data-sort="@item.EntryDate.ToString("yyyyMMdd")">@item.EntryDate.ToString("yyyy/MM/dd")</td>
                            <td>
                                @if (item.SourceModule == "Receipts")
                                {<span class="badge bg-success bg-opacity-75"><i class="bi bi-receipt"></i> سند قبض</span> }
                                else if (item.SourceModule == "GeneralExpenses")
                                { <span class="badge bg-danger bg-opacity-75"><i class="bi bi-cash-stack"></i> سند صرف</span> }
                                else if (item.SourceModule == "Manual")
                                { <span class="badge bg-primary bg-opacity-75"><i class="bi bi-pencil-square"></i> قيد يدوي</span> }
                                else if (item.SourceModule == "OpeningBalance")
                                { <span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> رصيد افتتاحي</span> }
                                else
                                { <span class="badge bg-secondary">@item.SourceModule</span>}
                            </td>
                            <td class="text-truncate" style="max-width: 300px;" title="@item.Description">@item.Description</td>
                            <td class="fw-bold text-end text-dark" data-val="@item.TotalDebit">@item.TotalDebit.ToString("N2")</td>
                            <td class="text-center small">@(item.FiscalYear?.Name ?? "-")</td>
                            <td class="text-center">
                                @if (item.IsPosted)
                                {<span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> مرحل</span> }
                                else
                                { <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split"></i> مسودة</span>}
                            </td>
                            <td class="text-center">
                                <div class="btn-group">
                                    <a href="@Url.Action("Details", new { id = item.Id })" class="btn btn-outline-info btn-sm"><i class="bi bi-eye"></i></a>
                                    <a href="@Url.Action("Print", new { id = item.Id })" target="_blank" class="btn btn-outline-dark btn-sm"><i class="bi bi-printer"></i></a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!Model.Any())
        {
            <div class="alert alert-info text-center mt-3 shadow-sm border-0">
                <i class="bi bi-info-circle me-2 fs-4 align-middle"></i>
                <span class="align-middle">لا توجد قيود يومية مسجلة.</span>
            </div>
        }
        else
        {
            <div class="d-flex justify-content-center mt-3">
                @Html.PagedListPager(Model, page => Url.Action("Index", new { page, searchString = ViewBag.CurrentFilter, sourceFilter = ViewBag.SourceFilter, fromDate = ViewBag.FromDate, toDate = ViewBag.ToDate }),
                new PagedListRenderOptions { LiElementClasses = new[] { "page-item" }, DisplayLinkToPreviousPage = PagedListDisplayMode.Always, DisplayLinkToNextPage = PagedListDisplayMode.Always, LinkToPreviousPageFormat = "السابق", LinkToNextPageFormat = "التالي" })
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        /**
         * دالة ترتيب الجدول برمجياً (Client-side Sorting)
         * param {number} n - رقم العمود المراد ترتيبه
         */
        function sortTable(n) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementById("journalTable");
            switching = true;
            dir = "asc";

            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];

                    let xContent = x.getAttribute("data-sort") || x.getAttribute("data-val") || x.innerText.toLowerCase();
                    let yContent = y.getAttribute("data-sort") || y.getAttribute("data-val") || y.innerText.toLowerCase();

                    // تحويل القيم الرقمية للمقارنة
                    if (n === 4) { // عمود الإجمالي
                        xContent = parseFloat(xContent) || 0;
                        yContent = parseFloat(yContent) || 0;
                    }

                    if (dir == "asc") {
                        if (xContent > yContent) { shouldSwitch = true; break; }
                    } else if (dir == "desc") {
                        if (xContent < yContent) { shouldSwitch = true; break; }
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount++;
                } else {
                    if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; }
                }
            }
            updateIcons(n, dir);
        }

        function updateIcons(n, dir) {
            const icons = document.querySelectorAll(".sort-icon");
            icons.forEach(icon => icon.className = "bi bi-arrow-down-up sort-icon");
            const activeIcon = table.rows[0].getElementsByTagName("TH")[n].querySelector("i");
            activeIcon.className = dir === "asc" ? "bi bi-sort-up sort-icon sort-active" : "bi bi-sort-down sort-icon sort-active";
        }
    </script>
}