@model PagedList.IPagedList<BarManegment.Models.JournalEntry>
@using PagedList.Mvc;

@{
    ViewBag.Title = "قيود اليومية";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<style>
    /* تنسيق مخصص لتعويض غياب AElementClasses في الإصدار القديم من PagedList */
    .pagination-container {
        text-align: center;
        margin-top: 20px;
    }

    .pagination {
        justify-content: center;
        display: flex;
        padding-left: 0;
        list-style: none;
    }

        .pagination .page-item .page-link,
        .pagination .page-item a {
            position: relative;
            display: block;
            padding: 0.5rem 0.75rem;
            margin-left: -1px;
            line-height: 1.25;
            color: #4e73df;
            background-color: #fff;
            border: 1px solid #dddfeb;
            text-decoration: none;
        }

        .pagination .page-item.active .page-link,
        .pagination .page-item.active a {
            z-index: 1;
            color: #fff;
            background-color: #4e73df;
            border-color: #4e73df;
        }

        .pagination .page-item:first-child a {
            border-top-right-radius: 0.35rem;
            border-bottom-right-radius: 0.35rem;
        }

        .pagination .page-item:last-child a {
            border-top-left-radius: 0.35rem;
            border-bottom-left-radius: 0.35rem;
        }
</style>

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">سجل الأستاذ العام (General Ledger)</h6>
        @if (BarManegment.Helpers.PermissionHelper.HasPermission("FinancialReports"))
        {
            <a href="@Url.Action("Create")" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-circle"></i> قيد يدوي جديد
            </a>
        }
    </div>
    <div class="card-body">

        @using (Html.BeginForm("Index", "JournalEntries", FormMethod.Get, new { @class = "row g-3 mb-4" }))
        {
            <div class="col-md-3">
                <label class="form-label small fw-bold">بحث شامل</label>
                <input type="text" name="searchString" value="@ViewBag.CurrentFilter" class="form-control" placeholder="رقم القيد / المرجع / البيان..." />
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold">من تاريخ</label>
                <input type="date" name="fromDate" value="@ViewBag.FromDate" class="form-control" />
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold">إلى تاريخ</label>
                <input type="date" name="toDate" value="@ViewBag.ToDate" class="form-control" />
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-secondary w-100"><i class="bi bi-search me-1"></i> عرض النتائج</button>
            </div>
        }

        <div class="table-responsive">
            <table class="table table-bordered table-hover table-striped align-middle" id="journalTable" width="100%" cellspacing="0">
                <thead class="table-dark text-white">
                    <tr>
                        <th style="width: 10%">رقم القيد</th>
                        <th style="width: 12%">التاريخ</th>
                        <th style="width: 10%">المصدر</th>
                        <th style="width: 35%">البيان</th>
                        <th style="width: 15%">الإجمالي</th>
                        <th style="width: 10%">الحالة</th>
                        <th style="width: 8%">إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="fw-bold text-center text-primary">#@item.EntryNumber</td>
                            <td>@item.EntryDate.ToString("yyyy-MM-dd")</td>
                            <td>
                                @if (item.SourceModule == "Receipts")
                                {
                                    <span class="badge bg-success">سند قبض</span>
                                }
                                else if (item.SourceModule == "GeneralExpenses")
                                {
                                    <span class="badge bg-danger">سند صرف</span>
                                }
                                else if (item.SourceModule == "Manual")
                                {
                                    <span class="badge bg-primary">قيد يدوي</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@item.SourceModule</span>
                                }

                                @if (!string.IsNullOrEmpty(item.ReferenceNumber))
                                {
                                    <div class="small text-muted mt-1" style="font-size: 0.75rem;">@item.ReferenceNumber</div>
                                }
                            </td>
                            <td class="text-truncate" style="max-width: 300px;" title="@item.Description">@item.Description</td>
                            <td class="fw-bold text-end">@item.TotalDebit.ToString("N2")</td>
                            <td class="text-center">
                                @if (item.IsPosted)
                                {
                                    <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> مرحل</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split"></i> مسودة</span>
                                }
                            </td>

                            <td class="text-center">
                                <div class="btn-group">
                                    <a href="@Url.Action("Details", new { id = item.Id })" class="btn btn-info btn-sm" title="تفاصيل"><i class="bi bi-eye"></i></a>
                                    <a href="@Url.Action("Print", new { id = item.Id })" target="_blank" class="btn btn-dark btn-sm" title="طباعة"><i class="bi bi-printer"></i></a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!Model.Any())
        {
            <div class="alert alert-info text-center mt-3">
                <i class="bi bi-info-circle me-2"></i> لا توجد قيود يومية مسجلة في النظام تطابق شروط البحث.
            </div>
        }
        else
        {
            <div class="d-flex justify-content-center mt-3">
                @Html.PagedListPager(Model, page => Url.Action("Index", new { page, searchString = ViewBag.CurrentFilter, fromDate = ViewBag.FromDate, toDate = ViewBag.ToDate }),
                new PagedListRenderOptions
                {
                    LiElementClasses = new[] { "page-item" },
                    DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
                    DisplayLinkToNextPage = PagedListDisplayMode.Always,
                    LinkToPreviousPageFormat = "السابق",
                    LinkToNextPageFormat = "التالي",
                    MaximumPageNumbersToDisplay = 5
                })
            </div>
        }
    </div>
</div>