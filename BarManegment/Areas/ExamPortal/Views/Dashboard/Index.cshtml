@model BarManegment.Areas.ExamPortal.ViewModels.ExamDashboardViewModel
@{
    ViewBag.Title = "لوحة التحكم - بوابة الامتحانات";
    Layout = "~/Areas/ExamPortal/Views/Shared/_ExamLayout.cshtml";
}

<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            @* ========================================================= *@
            @* 1. بطاقة الترحيب + زر تسجيل الخروج *@
            @* ========================================================= *@
            <div class="card shadow-sm mb-4 border-top border-4 border-primary">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0 fw-bold text-dark">
                            <i class="bi bi-person-circle text-primary me-2"></i> مرحباً, @Model.TraineeName
                        </h4>
                        <small class="text-muted me-4">نتمنى لك التوفيق في اختباراتك</small>
                    </div>

                    @* زر تسجيل الخروج *@
                    @using (Html.BeginForm("LogOff", "ExamLogin", new { area = "ExamPortal" }, FormMethod.Post))
                    {
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-danger fw-bold btn-sm px-3" onclick="return confirm('هل أنت متأكد من رغبتك في تسجيل الخروج؟')">
                            <i class="bi bi-box-arrow-left me-1"></i> خروج
                        </button>
                    }
                </div>
            </div>

            @* ========================================================= *@
            @* 2. قسم الامتحانات الفعالة (Active Exams) *@
            @* ========================================================= *@
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-primary text-white py-3 d-flex align-items-center">
                    <i class="bi bi-stopwatch-fill fs-5 me-2"></i>
                    <h5 class="mb-0">الاختبارات الفعالة والقادمة</h5>
                </div>
                <div class="card-body p-4 bg-light bg-opacity-10">
                    @if (!Model.ActiveExams.Any())
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-calendar-x fs-1 d-block mb-2 opacity-50"></i>
                            <p class="mb-0">لا توجد اختبارات فعالة أو قادمة مسجل بها حاليًا.</p>
                        </div>
                    }
                    else
                    {
                        foreach (var enrollment in Model.ActiveExams)
                        {
                            // حساب الوقت المتبقي
                            int secondsRemaining = (int)(enrollment.Exam.StartTime - DateTime.Now).TotalSeconds;
                            bool isExamStarted = secondsRemaining <= 0;

                            // تنسيق الحالة
                            string buttonClass = isExamStarted ? "btn-primary pulse-button" : "btn-secondary disabled";
                            string alertClass = isExamStarted ? "alert-success" : "alert-info";
                            string initialText = isExamStarted ? "الامتحان متاح الآن" : "جارٍ تحميل الوقت...";

                            <div class="card border mb-3 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="card-title fw-bold text-dark mb-0">
                                            <i class="bi bi-journal-text me-2 text-primary"></i>@enrollment.Exam.Title
                                        </h5>
                                        <span class="badge bg-primary">@enrollment.Exam.ExamType.Name</span>
                                    </div>

                                    <div class="row text-center mb-3 bg-light rounded p-2 mx-0">
                                        <div class="col-6 border-end">
                                            <small class="text-muted d-block">موعد البدء</small>
                                            <span class="fw-bold" dir="ltr">@enrollment.Exam.StartTime.ToString("yyyy/MM/dd HH:mm")</span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">المدة</small>
                                            <span class="fw-bold">@enrollment.Exam.DurationInMinutes دقيقة</span>
                                        </div>
                                    </div>

                                    @* منطقة العداد *@
                                    <div id="cnt_@enrollment.Id"
                                         class="alert @alertClass fs-6 fw-bold countdown-timer text-center shadow-sm mb-3"
                                         data-seconds="@secondsRemaining"
                                         data-id="@enrollment.Id">
                                        @if (isExamStarted)
                                        {
                                            <span><i class="bi bi-check-circle-fill me-2"></i> الامتحان متاح الآن</span>
                                        }
                                        else
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span> <span>@initialText</span>
                                        }
                                    </div>

                                    @* زر البدء *@
                                    <a href="@Url.Action("StartExam", "TakeExam", new { enrollmentId = enrollment.Id })"
                                       id="btn_@enrollment.Id"
                                       class="btn btn-lg w-100 fw-bold @buttonClass">
                                        <i class="bi bi-play-circle-fill me-2"></i> دخول للامتحان
                                    </a>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            @* ========================================================= *@
            @* 3. قسم الامتحانات السابقة (Finished Exams) *@
            @* ========================================================= *@
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 border-bottom d-flex align-items-center">
                    <div class="bg-secondary bg-opacity-10 text-secondary rounded-circle p-2 me-2">
                        <i class="bi bi-clock-history fs-5"></i>
                    </div>
                    <h5 class="mb-0 fw-bold text-secondary">سجل الاختبارات السابقة</h5>
                </div>

                <div class="card-body p-0">
                    @if (!Model.FinishedExams.Any())
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-clipboard-x fs-1 d-block mb-3 opacity-50"></i>
                            <p>لا يوجد سجل اختبارات سابقة حتى الآن.</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light text-muted">
                                    <tr>
                                        <th class="ps-4 py-3">اسم الامتحان</th>
                                        <th>تاريخ التقديم</th>
                                        <th>العلامة</th>
                                        <th>التقدير</th>
                                        <th class="text-end pe-4">التفاصيل</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.FinishedExams)
                                    {
                                        <tr>
                                            <td class="ps-4 fw-bold text-dark">
                                                @item.Exam.Title
                                                <div class="small text-muted fw-normal">@item.Exam.ExamType.Name</div>
                                            </td>

                                            <td>@item.Exam.StartTime.ToString("yyyy/MM/dd")</td>

                                            <td>
                                                @if (item.Score.HasValue)
                                                {
                                                    @* 🛠️ تم التعديل هنا: حذفنا TotalScore لأنه غير موجود *@
                                                    <span class="fw-bold">@item.Score</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted small">--</span>
                                                }
                                            </td>

                                            <td>
                                                @if (item.Result == "ناجح")
                                                {
                                                    <span class="badge bg-success bg-opacity-10 text-success border border-success px-3 rounded-pill">
                                                        <i class="bi bi-check-circle-fill me-1"></i> ناجح
                                                    </span>
                                                }
                                                else if (item.Result == "راسب")
                                                {
                                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-3 rounded-pill">
                                                        <i class="bi bi-x-circle-fill me-1"></i> راسب
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary bg-opacity-10 text-secondary border px-3 rounded-pill">
                                                        <i class="bi bi-hourglass-split me-1"></i> @(item.Result ?? "منتهي")
                                                    </span>
                                                }
                                            </td>

                                            <td class="text-end pe-4">
                                                @if (!string.IsNullOrEmpty(item.Result))
                                                {
                                                    <a href="@Url.Action("Result", "TakeExam", new { enrollmentId = item.Id })" class="btn btn-sm btn-outline-primary shadow-sm">
                                                        <i class="bi bi-card-list me-1"></i> عرض النتيجة
                                                    </a>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-sm btn-light text-muted disabled border" disabled>النتيجة قريباً</button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // دالة تحديث العداد
            function tickTimer(element) {
                var el = $(element);
                var id = el.data('id');
                var seconds = parseInt(el.data('seconds'));
                var btn = $('#btn_' + id);

                seconds = seconds - 1;
                el.data('seconds', seconds);

                // إذا بدأ وقت الامتحان
                if (seconds <= 0) {
                    if (btn.hasClass('disabled')) {
                        el.removeClass('alert-info').addClass('alert-success');
                        el.html('<i class="bi bi-check-circle-fill me-2"></i> الامتحان متاح الآن');
                        btn.removeClass('btn-secondary disabled').addClass('btn-primary pulse-button');
                        btn.removeAttr('disabled');
                    }
                    return;
                }

                // حساب الوقت المتبقي
                var days = Math.floor(seconds / (3600 * 24));
                var hours = Math.floor((seconds % (3600 * 24)) / 3600);
                var minutes = Math.floor((seconds % 3600) / 60);
                var sec = Math.floor(seconds % 60);

                var timeStr = "";
                if (days > 0) timeStr += days + " يوم ";
                if (hours > 0) timeStr += hours + " س ";
                timeStr += minutes + " د " + sec + " ث";

                el.html('<i class="bi bi-hourglass-split me-2"></i> يفتح بعد: <span dir="ltr" class="fw-bold">' + timeStr + '</span>');
            }

            // تشغيل العداد كل ثانية
            setInterval(function () {
                $('.countdown-timer').each(function () { tickTimer(this); });
            }, 1000);

            // تشغيل أولي
            $('.countdown-timer').each(function () { tickTimer(this); });
        });
    </script>

    <style>
        /* 🛠️ تم الإصلاح: استخدام @@ لتعريف keyframes في Razor */
        @@keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
            }
        }

        .pulse-button {
            animation: pulse 2s infinite;
        }
    </style>
}